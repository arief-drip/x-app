<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="X Journal">
    <meta name="description" content="Journaling app with beautiful design and offline storage">
    <title>X Journal â€” Capture Your Thoughts</title>
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%234f46e5' rx='20' width='100' height='100'/><text x='50%' y='50%' dominant-baseline='central' text-anchor='middle' font-size='60'>ðŸ““</text></svg>">
    <link rel="manifest" id="manifestLink">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        
        /* Background Options */
        body {
            min-height: 100vh;
            transition: background 0.5s ease;
        }
        
        body.bg-gradient {
            background-size: 200% 200%;
            animation: gradientShift 25s ease infinite;
        }
        
        body.bg-image {
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* More subtle ambient for mature look */
        .ambient-subtle {
            opacity: 0.15 !important;
            filter: blur(100px) !important;
        }
        
        /* Gradient Variants - Vibrant & Animated */
        .gradient-purple {
            background: linear-gradient(-45deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
            background-size: 400% 400%;
        }
        
        .gradient-black-red {
            background: linear-gradient(-45deg, #ff0844 0%, #ffb199 25%, #ff512f 50%, #dd2476 75%, #ff6b6b 100%);
            background-size: 400% 400%;
        }
        
        .gradient-ocean {
            background: linear-gradient(-45deg, #2193b0 0%, #6dd5ed 25%, #00d2ff 50%, #3a7bd5 75%, #00d2ff 100%);
            background-size: 400% 400%;
        }
        
        .gradient-sunset {
            background: linear-gradient(-45deg, #f12711 0%, #f5af19 25%, #ff512f 50%, #f09819 75%, #ff6a00 100%);
            background-size: 400% 400%;
        }
        
        .gradient-forest {
            background: linear-gradient(-45deg, #11998e 0%, #38ef7d 25%, #00b09b 50%, #96c93d 75%, #56ab2f 100%);
            background-size: 400% 400%;
        }
        
        .gradient-cosmic {
            background: linear-gradient(-45deg, #330867 0%, #30cfd0 25%, #a8edea 50%, #fed6e3 75%, #ff9a9e 100%);
            background-size: 400% 400%;
        }
        
        .gradient-midnight {
            background: linear-gradient(-45deg, #2c3e50 0%, #3498db 25%, #6c5ce7 50%, #a29bfe 75%, #fd79a8 100%);
            background-size: 400% 400%;
        }
        
        /* Extra vibrant gradients */
        .gradient-candy {
            background: linear-gradient(-45deg, #ff9a9e 0%, #fecfef 25%, #fecfef 50%, #fad0c4 75%, #ffecd2 100%);
            background-size: 400% 400%;
        }
        
        .gradient-aurora {
            background: linear-gradient(-45deg, #00c9ff 0%, #92fe9d 25%, #00d2ff 50%, #3a7bd5 75%, #00c6ff 100%);
            background-size: 400% 400%;
        }
        
        .gradient-neon {
            background: linear-gradient(-45deg, #f093fb 0%, #f5576c 25%, #4facfe 50%, #00f2fe 75%, #43e97b 100%);
            background-size: 400% 400%;
        }
        
        .gradient-gold {
            background: linear-gradient(-45deg, #f5af19 0%, #f12711 25%, #fddb92 50%, #d1fdff 75%, #f5af19 100%);
            background-size: 400% 400%;
        }
        
        .gradient-berry {
            background: linear-gradient(-45deg, #8e2de2 0%, #4a00e0 25%, #da22ff 50%, #9733ee 75%, #8e2de2 100%);
            background-size: 400% 400%;
        }
        
        .gradient-sherbet {
            background: linear-gradient(-45deg, #ff9a9e 0%, #fecfef 25%, #ffecd2 50%, #fcb69f 75%, #ff9a9e 100%);
            background-size: 400% 400%;
        }
        
        .gradient-oceanic {
            background: linear-gradient(-45deg, #2193b0 0%, #6dd5ed 25%, #2e3192 50%, #1cb5e0 75%, #000851 100%);
            background-size: 400% 400%;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.82);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.25);
        }
        
        .glass-dark {
            background: rgba(15, 15, 20, 0.9);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .journal-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .journal-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.2);
        }
        
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .accordion-content.open {
            max-height: 3000px;
        }
        
        .entry-card {
            animation: slideUpFade 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideUpFade {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
            50% { transform: scale(1.02); box-shadow: 0 0 20px 10px rgba(99, 102, 241, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }
        
        .emoji-btn {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .emoji-btn:hover {
            transform: scale(1.25) rotate(5deg);
        }
        
        .emoji-btn.selected {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transform: scale(1.12);
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(79, 70, 229, 0.35);
        }
        
        .input-glass {
            background: rgba(255, 255, 255, 0.6);
            border: 1.5px solid rgba(255, 255, 255, 0.25);
            transition: all 0.3s ease;
        }
        
        .input-glass:focus {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(99, 102, 241, 0.5);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.08);
        }
        
        .mood-indicator {
            animation: float 4s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        
        .rotate-arrow {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .rotate-arrow.open {
            transform: rotate(180deg);
        }
        
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.2);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(99, 102, 241, 0.4);
        }
        
        .badge {
            background: rgba(99, 102, 241, 0.08);
            border: 1px solid rgba(99, 102, 241, 0.15);
        }
        
        .entry-time {
            font-variant-numeric: tabular-nums;
        }
        
        .toast {
            animation: toastSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes toastSlide {
            from {
                transform: translateX(100%) translateY(-50%);
                opacity: 0;
            }
            to {
                transform: translateX(0) translateY(-50%);
                opacity: 1;
            }
        }
        
        /* Background Selector Styles */
        .bg-option {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .bg-option:hover {
            transform: scale(1.05);
        }
        
        .bg-option.selected {
            ring: 3px;
            ring-color: #667eea;
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .bg-selector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .modal-overlay {
            background: rgba(0, 0, 0, 0.65);
            backdrop-filter: blur(8px);
        }
        
        /* Dropdown animations */
        .dropdown-menu {
            animation: dropdownFade 0.2s ease-out;
            transform-origin: top right;
        }
        
        @keyframes dropdownFade {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        /* Milestone Notification */
        .milestone-toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 90;
            animation: milestoneSlide 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .milestone-toast:hover {
            transform: translateY(-2px) scale(1.02);
        }
        
        .milestone-toast.hiding {
            animation: milestoneHide 0.3s ease forwards;
        }
        
        @keyframes milestoneSlide {
            from {
                opacity: 0;
                transform: translateX(100%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0) translateY(0);
            }
        }
        
        @keyframes milestoneHide {
            to {
                opacity: 0;
                transform: translateX(100%) translateY(20px);
            }
        }
        
        .milestone-pulse {
            animation: milestonePulse 2s ease-in-out infinite;
        }
        
        @keyframes milestonePulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
            50% { box-shadow: 0 0 20px 8px rgba(99, 102, 241, 0); }
        }
    </style>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0XETKYGZYT"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-0XETKYGZYT');
    </script>
</head>
<body class="bg-gradient antialiased gradient-purple">
    <!-- Ambient Background Elements (hidden when using image bg) -->
    <div id="ambientBg" class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute top-0 left-1/4 w-96 h-96 bg-slate-400 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse" style="animation-duration: 8s;"></div>
        <div class="absolute bottom-0 right-1/4 w-96 h-96 bg-zinc-400 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse" style="animation-delay: 3s; animation-duration: 10s;"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-96 h-96 bg-neutral-400 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse" style="animation-delay: 6s; animation-duration: 12s;"></div>
    </div>

    <!-- Analytics Modal -->
    <div id="analyticsModal" class="fixed inset-0 z-[70] hidden modal-overlay items-center justify-center p-3" onclick="if(event.target === this) closeAnalyticsModal()">
        <div class="glass rounded-3xl p-4 md:p-6 max-w-2xl w-full max-h-[95vh] md:max-h-[85vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4 md:mb-6">
                <div class="flex items-center gap-2 md:gap-3">
                    <div class="w-8 h-8 md:w-10 md:h-10 rounded-xl bg-gradient-to-br from-violet-500 to-fuchsia-500 flex items-center justify-center">
                        <svg class="w-4 h-4 md:w-5 md:h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-lg md:text-xl font-bold text-slate-800">Journaling Statistics</h2>
                        <p class="text-xs text-slate-500">Your journey insights</p>
                    </div>
                </div>
                <button onclick="closeAnalyticsModal()" class="p-2 hover:bg-slate-100 rounded-full transition-colors">
                    <svg class="w-5 h-5 md:w-6 md:h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div id="analyticsContent" class="grid grid-cols-2 gap-2 md:gap-3 overflow-hidden">
                <!-- Content will be populated by JavaScript -->
            </div>
            
            <!-- Summary Footer -->
            <div class="mt-4 p-3 bg-gradient-to-r from-violet-50 to-fuchsia-50 rounded-xl md:rounded-2xl border border-violet-100">
                <p class="text-xs md:text-sm text-slate-600 text-center italic" id="analyticsQuote">
                    "Consistency is the key to mastery."
                </p>
            </div>
            
            <!-- Install PWA -->
            <div class="mt-4 p-3 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl md:rounded-2xl border border-blue-100">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold text-slate-700">Install X Journal</p>
                        <p class="text-xs text-slate-500">Faster access from home screen</p>
                    </div>
                    <button id="installPwaBtn" onclick="installPWA()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium rounded-lg transition-colors flex-shrink-0">
                        Install
                    </button>
                </div>
                <div id="iosInstallHint" class="hidden mt-3 pt-3 border-t border-blue-100">
                    <p class="text-xs text-slate-600">
                        <span class="font-medium">iOS:</span> Tap <svg class="w-4 h-4 inline mx-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" strokeLinejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg> then "Add to Home Screen"
                    </p>
                </div>
                <div id="androidInstallHint" class="hidden mt-3 pt-3 border-t border-blue-100">
                    <p class="text-xs text-slate-600">
                        <span class="font-medium">Android:</span> Tap menu <span class="font-bold">â‹®</span> in Chrome â†’ "Install" or "Add to Home screen"
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div id="resetModal" class="fixed inset-0 z-[80] hidden modal-overlay items-center justify-center p-3" onclick="if(event.target === this) closeResetModal()">
        <div class="glass rounded-3xl p-6 max-w-md w-full" onclick="event.stopPropagation()">
            <div class="text-center mb-6">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-100 flex items-center justify-center">
                    <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" strokeLinejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
                <h2 class="text-xl font-bold text-slate-800 mb-2">Reset All Data</h2>
                <p class="text-sm text-slate-500">This action cannot be undone</p>
            </div>
            
            <div class="space-y-4 mb-6">
                <div class="flex items-start gap-3 p-3 bg-red-50 rounded-xl">
                    <svg class="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" strokeLinejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    <p class="text-sm text-slate-700">Reset will <span class="font-semibold text-red-600">permanently delete all journals and entries</span></p>
                </div>
                
                <div class="flex items-start gap-3 p-3 bg-amber-50 rounded-xl">
                    <svg class="w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" strokeLinejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                    <p class="text-sm text-slate-700">Make sure you have <span class="font-semibold">backed up (exported)</span> important data first</p>
                </div>
            </div>
            
            <div class="mb-6">
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" id="resetConfirmCheckbox" class="w-5 h-5 rounded border-slate-300 text-red-600 focus:ring-red-500" onchange="toggleResetButton()">
                    <span class="text-sm text-slate-700">I understand and accept the consequences</span>
                </label>
            </div>
            
            <div class="flex gap-3">
                <button onclick="closeResetModal()" class="flex-1 py-3 px-4 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium rounded-xl transition-colors">
                    Cancel
                </button>
                <button id="resetConfirmBtn" onclick="resetAllData()" disabled class="flex-1 py-3 px-4 bg-red-500 text-white font-medium rounded-xl transition-all opacity-50 cursor-not-allowed">
                    Reset Data
                </button>
            </div>
        </div>
    </div>

    <!-- Journaling Coach Tooltip -->
    <div id="coachContainer" class="fixed inset-0 z-[100] hidden pointer-events-none">
        <!-- SVG Overlay dengan cutout -->
        <svg class="absolute inset-0 w-full h-full" id="coachSvgOverlay">
            <defs>
                <mask id="coachMask">
                    <rect x="0" y="0" width="100%" height="100%" fill="white"/>
                    <rect id="coachCutout" x="0" y="0" width="0" height="0" rx="12" fill="black"/>
                </mask>
            </defs>
            <rect x="0" y="0" width="100%" height="100%" fill="rgba(15, 23, 42, 0.75)" mask="url(#coachMask)" class="pointer-events-auto"/>
        </svg>
        
        <!-- Tooltip -->
        <div id="coachTooltip" class="absolute pointer-events-auto" style="max-width: 300px;">
            <div class="glass rounded-2xl p-4 shadow-2xl border border-emerald-200/50 bg-white/95">
                <!-- Progress -->
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs font-medium text-slate-400" id="coachStepNumber">Step 1/18</span>
                    <div class="flex items-center gap-1" id="coachProgressDots">
                        <!-- Generated via JS -->
                    </div>
                </div>
                
                <!-- Content -->
                <h3 id="coachTitle" class="text-base font-bold text-slate-800 mb-1.5">Welcome</h3>
                <p id="coachContent" class="text-sm text-slate-600 leading-relaxed mb-3">Let's explore X Journal together!</p>
                
                <!-- Navigation -->
                <div class="flex items-center gap-2">
                    <button onclick="endCoach()" class="px-3 py-1.5 text-xs text-slate-400 hover:text-slate-600 transition-colors">
                        Skip
                    </button>
                    <div class="flex-1"></div>
                    <button onclick="prevCoachStep()" id="coachPrevBtn" class="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-600 font-medium rounded-lg transition-colors text-xs">
                        Back
                    </button>
                    <button onclick="nextCoachStep()" id="coachNextBtn" class="px-4 py-1.5 bg-emerald-500 hover:bg-emerald-600 text-white font-medium rounded-lg transition-all text-xs shadow-sm">
                        Next
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Background Selector Modal -->
    <div id="bgModal" class="fixed inset-0 z-[60] hidden modal-overlay items-center justify-center p-3 md:p-4" onclick="if(event.target === this) closeBgModal()">
        <div class="glass rounded-3xl p-4 md:p-6 max-w-2xl w-full max-h-[85vh] flex flex-col" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4 md:mb-6 flex-shrink-0">
                <div>
                    <h2 class="text-lg md:text-xl font-bold text-slate-800">Choose Background</h2>
                    <p class="text-xs md:text-sm text-slate-500 mt-0.5">Select a theme for your journaling experience</p>
                </div>
                <button onclick="closeBgModal()" class="p-2 hover:bg-slate-100 rounded-full transition-colors flex-shrink-0">
                    <svg class="w-5 h-5 md:w-6 md:h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" strokeLinejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Scrollable Content -->
            <div class="overflow-y-auto flex-1 pr-1 -mr-1" style="scrollbar-width: thin;">
                <!-- Gradient Options -->
                <div class="mb-4 md:mb-6">
                    <h3 class="text-xs md:text-sm font-semibold text-slate-600 uppercase tracking-wider mb-2 md:mb-3">âœ¨ Animated Gradients</h3>
                    <div class="grid grid-cols-4 sm:grid-cols-7 gap-2">
                        <div onclick="setBackground('gradient', 'purple', 'g-purple')" id="bg-g-purple" 
                             class="bg-option selected h-12 sm:h-16 rounded-xl gradient-purple shadow-md cursor-pointer border-2 border-white" title="Neon Purple"></div>
                        <div onclick="setBackground('gradient', 'black-red', 'g-black-red')" id="bg-g-black-red" 
                             class="bg-option h-12 sm:h-16 rounded-xl gradient-black-red shadow-md cursor-pointer border-2 border-white" title="Hot Coral"></div>
                        <div onclick="setBackground('gradient', 'ocean', 'g-ocean')" id="bg-g-ocean" 
                             class="bg-option h-12 sm:h-16 rounded-xl gradient-ocean shadow-md cursor-pointer border-2 border-white" title="Ocean Blue"></div>
                        <div onclick="setBackground('gradient', 'sunset', 'g-sunset')" id="bg-g-sunset" 
                             class="bg-option h-12 sm:h-16 rounded-xl gradient-sunset shadow-md cursor-pointer border-2 border-white" title="Tropical Sunset"></div>
                        <div onclick="setBackground('gradient', 'forest', 'g-forest')" id="bg-g-forest" 
                             class="bg-option h-12 sm:h-16 rounded-xl gradient-forest shadow-md cursor-pointer border-2 border-white" title="Fresh Mint"></div>
                        <div onclick="setBackground('gradient', 'cosmic', 'g-cosmic')" id="bg-g-cosmic" 
                             class="bg-option h-12 sm:h-16 rounded-xl gradient-cosmic shadow-md cursor-pointer border-2 border-white" title="Cosmic Dreams"></div>
                        <div onclick="setBackground('gradient', 'midnight', 'g-midnight')" id="bg-g-midnight" 
                             class="bg-option h-12 sm:h-16 rounded-xl gradient-midnight shadow-md cursor-pointer border-2 border-white" title="Midnight Magic"></div>
                        <div onclick="setBackground('gradient', 'candy', 'g-candy')" id="bg-g-candy" 
                             class="bg-option h-12 sm:h-16 rounded-xl gradient-candy shadow-md cursor-pointer border-2 border-white" title="Cotton Candy"></div>
                        <div onclick="setBackground('gradient', 'aurora', 'g-aurora')" id="bg-g-aurora" 
                             class="bg-option h-12 sm:h-16 rounded-xl gradient-aurora shadow-md cursor-pointer border-2 border-white" title="Aurora Borealis"></div>
                        <div onclick="setBackground('gradient', 'neon', 'g-neon')" id="bg-g-neon" 
                             class="bg-option h-12 sm:h-16 rounded-xl gradient-neon shadow-md cursor-pointer border-2 border-white" title="Cyber Neon"></div>
                        <div onclick="setBackground('gradient', 'gold', 'g-gold')" id="bg-g-gold" 
                             class="bg-option h-12 sm:h-16 rounded-xl gradient-gold shadow-md cursor-pointer border-2 border-white" title="Golden Hour"></div>
                        <div onclick="setBackground('gradient', 'berry', 'g-berry')" id="bg-g-berry" 
                             class="bg-option h-12 sm:h-16 rounded-xl gradient-berry shadow-md cursor-pointer border-2 border-white" title="Berry Burst"></div>
                        <div onclick="setBackground('gradient', 'sherbet', 'g-sherbet')" id="bg-g-sherbet" 
                             class="bg-option h-12 sm:h-16 rounded-xl gradient-sherbet shadow-md cursor-pointer border-2 border-white" title="Orange Sherbet"></div>
                        <div onclick="setBackground('gradient', 'oceanic', 'g-oceanic')" id="bg-g-oceanic" 
                             class="bg-option h-12 sm:h-16 rounded-xl gradient-oceanic shadow-md cursor-pointer border-2 border-white" title="Deep Oceanic"></div>
                    </div>
                </div>
                
                <!-- Nature Images -->
                <div class="mb-4 md:mb-6">
                    <h3 class="text-xs md:text-sm font-semibold text-slate-600 uppercase tracking-wider mb-2 md:mb-3">Nature</h3>
                    <div class="bg-selector-grid" id="natureGrid"></div>
                </div>
                
                <!-- Cityscape Images -->
                <div>
                    <h3 class="text-xs md:text-sm font-semibold text-slate-600 uppercase tracking-wider mb-2 md:mb-3">Cityscape</h3>
                    <div class="bg-selector-grid" id="cityGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 z-50 glass border-b border-white/10">
        <div class="max-w-3xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-2xl bg-slate-800 flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-slate-800">X Journal</h1>
                        <p class="text-xs text-slate-500 font-medium">Capture your thoughts</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-1">
                    <!-- Background Toggle Button -->
                    <button onclick="openBgModal()" class="p-2.5 rounded-xl hover:bg-slate-100/50 transition-all group" title="Change Background">
                        <svg class="w-5 h-5 text-slate-600 group-hover:text-slate-800 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    </button>
                    
                    <!-- Data Menu Dropdown -->
                    <div class="relative" id="dataMenuContainer">
                        <button onclick="toggleDropdown('dataMenu')" class="p-2.5 rounded-xl hover:bg-slate-100/50 transition-all group" title="Data">
                            <svg class="w-5 h-5 text-slate-600 group-hover:text-slate-800 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path>
                            </svg>
                        </button>
                        <div id="dataMenu" class="hidden dropdown-menu absolute right-0 top-full mt-2 w-48 glass rounded-xl shadow-xl border border-white/20 overflow-hidden">
                            <input type="file" id="importFile" accept=".json" class="hidden" onchange="importData(this)">
                            <button onclick="document.getElementById('importFile').click(); closeDropdown('dataMenu')" class="w-full px-4 py-3 text-left text-sm text-slate-700 hover:bg-slate-100/50 transition-colors flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                                </svg>
                                Import
                            </button>
                            <button onclick="exportData(); closeDropdown('dataMenu')" class="w-full px-4 py-3 text-left text-sm text-slate-700 hover:bg-slate-100/50 transition-colors flex items-center gap-2 border-t border-slate-100">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                                Export
                            </button>
                            <button onclick="openAnalyticsModal(); closeDropdown('dataMenu')" class="w-full px-4 py-3 text-left text-sm text-slate-700 hover:bg-slate-100/50 transition-colors flex items-center gap-2 border-t border-slate-100">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                Data Analysis
                            </button>
                            <button onclick="startJournalingCoach(); closeDropdown('dataMenu')" class="w-full px-4 py-3 text-left text-sm text-emerald-600 hover:bg-emerald-50 transition-colors flex items-center gap-2 border-t border-slate-100">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" strokeLinejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                </svg>
                                Journaling Coach
                            </button>
                            <button onclick="openResetModal(); closeDropdown('dataMenu')" class="w-full px-4 py-3 text-left text-sm text-red-600 hover:bg-red-50 transition-colors flex items-center gap-2 border-t border-slate-100">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" strokeLinejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                Reset Data
                            </button>
                        </div>
                    </div>
                    
                    <!-- Love/About Menu Dropdown -->
                    <div class="relative" id="loveMenuContainer">
                        <button onclick="toggleDropdown('loveMenu')" class="p-2.5 rounded-xl hover:bg-slate-100/50 transition-all group" title="About">
                            <svg class="w-5 h-5 text-slate-600 group-hover:text-slate-800 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                            </svg>
                        </button>
                        <div id="loveMenu" class="hidden dropdown-menu absolute right-0 top-full mt-2 w-72 glass rounded-xl shadow-xl border border-white/20 overflow-hidden">
                            <div class="p-4 border-b border-slate-100">
                                <p class="text-sm text-slate-600 leading-relaxed">
                                    Your journal is stored locally using <strong>IndexedDB</strong> â€” 
                                    no data leaves your device. We recommend <strong>exporting regularly</strong> to keep your memories safe.
                                </p>
                            </div>
                            <div class="p-4 bg-slate-50/50">
                                <p class="text-xs text-slate-500 mb-3">Crafted with care by <strong class="text-slate-700">Arief Rachmansyah</strong></p>
                                <div class="flex flex-col gap-2">
                                    <a href="https://slugpost.com/arief-rachmansyah" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2.5 text-sm text-slate-600 hover:text-slate-900 hover:bg-white/60 px-2 py-2 rounded-lg transition-all">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path>
                                        </svg>
                                        <span>Website</span>
                                    </a>
                                    <a href="https://instagram.com/arief.drip" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2.5 text-sm text-slate-600 hover:text-slate-900 hover:bg-white/60 px-2 py-2 rounded-lg transition-all">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                                        </svg>
                                        <span>Instagram</span>
                                    </a>
                                    <a href="https://threads.net/arief.drip" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2.5 text-sm text-slate-600 hover:text-slate-900 hover:bg-white/60 px-2 py-2 rounded-lg transition-all">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12.186 24h-.007c-3.581-.024-6.334-1.205-8.184-3.509C2.35 18.44 1.5 15.586 1.472 12.01v-.017c.03-3.579.879-6.43 2.525-8.482C5.845 1.205 8.6.024 12.18 0h.014c2.746.02 5.043.725 6.826 2.098 1.677 1.29 2.858 3.13 3.509 5.467l-2.04.569c-1.104-3.96-3.898-5.984-8.304-6.015-2.91.022-5.11.936-6.54 2.717C4.307 6.504 3.616 8.914 3.59 12c.025 3.086.718 5.496 2.152 7.164 1.432 1.781 3.632 2.695 6.542 2.717 4.408-.03 7.202-2.055 8.305-6.016l2.04.57c-.651 2.337-1.832 4.177-3.51 5.467-1.783 1.373-4.08 2.078-6.826 2.098h-.097zm6.627-8.042l-.971-1.144 1.536-1.303.973 1.144-1.538 1.303zm-3.417 2.508l-1.038-1.09 1.467-1.396 1.037 1.089-1.466 1.397zm-4.186 1.312l-.924-1.193 1.605-1.242.924 1.192-1.605 1.243zm-3.465-2.102l-.825-1.261 1.698-1.111.825 1.261-1.698 1.111z"/>
                                        </svg>
                                        <span>Threads</span>
                                    </a>
                                    <a href="https://paypal.me/ariefdrip" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2.5 text-sm text-emerald-600 hover:text-emerald-700 hover:bg-emerald-50 px-2 py-2 rounded-lg transition-all mt-1">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                        </svg>
                                        <span>Support X Journal</span>
                                    </a>
                                </div>
                            </div>
                            <div class="p-4 bg-gradient-to-r from-emerald-50 to-teal-50 border-t border-emerald-100">
                                <p class="text-xs text-slate-600 mb-3 leading-relaxed">
                                    ðŸ’š I'd be super happy if you'd like to give a testimonial...
                                </p>
                                <a href="https://wa.me/628567892460?text=Mas%2C%20saya%20mau%20ngasi%20Testimoni%20X%20Journal.." 
                                   target="_blank" rel="noopener noreferrer"
                                   class="flex items-center justify-center gap-2 w-full py-2.5 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-medium rounded-xl transition-all shadow-lg shadow-emerald-500/20 hover:shadow-emerald-500/30">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                                    </svg>
                                    <span>Give Testimonial</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="relative z-10 max-w-3xl mx-auto px-4 pt-24 pb-32">
        
        <!-- Create New Journal Card -->
        <div class="glass rounded-3xl p-6 mb-4 shadow-xl shadow-black/5">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                </div>
                <h2 class="font-semibold text-slate-800">New Journal</h2>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-3">
                <input type="text" id="newJournalTitle" placeholder="What's this journal about?" 
                       class="flex-1 px-4 py-3.5 input-glass rounded-xl text-slate-700 placeholder-slate-400 focus:outline-none text-sm">
                <button onclick="addParent()" class="btn-primary px-6 py-3.5 text-white font-medium rounded-xl flex items-center justify-center gap-2 whitespace-nowrap">
                    <span>Create</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Journals List -->
        <div id="journalsList" class="space-y-4"></div>

        <!-- Empty State / Onboarding -->
        <div id="emptyState" class="hidden mt-2">
            <!-- Card Empty State -->
            <div class="glass rounded-3xl p-5 shadow-xl shadow-black/5 text-center relative z-10">
                <!-- Icon -->
                <div class="w-16 h-16 mx-auto mb-3 relative">
                    <div class="absolute inset-0 bg-gradient-to-br from-violet-400 to-fuchsia-400 rounded-full opacity-20 blur-xl"></div>
                    <div class="relative w-full h-full bg-gradient-to-br from-violet-100 to-fuchsia-100 rounded-2xl flex items-center justify-center">
                        <span class="text-3xl">ðŸ“–</span>
                    </div>
                </div>
                
                <!-- Title & Subtitle -->
                <h3 class="text-lg font-bold text-slate-800 mb-1">No Journals Yet</h3>
                <p class="text-sm text-slate-500 max-w-sm mx-auto mb-4">Start by creating a new journal or take a quick tour</p>
                
                <!-- CTA Buttons -->
                <div class="flex flex-col sm:flex-row gap-2 justify-center">
                    <button onclick="startTour()" class="px-5 py-2.5 bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm font-medium rounded-xl transition-colors inline-flex items-center justify-center gap-2">
                        <span>ðŸŽ¯</span>
                        <span>See How It Works</span>
                    </button>
                    <button onclick="showTemplateModal()" class="btn-primary px-5 py-2.5 text-white text-sm font-medium rounded-xl inline-flex items-center justify-center gap-2">
                        <span>ðŸ“¦</span>
                        <span>View Templates</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Tour Modal (Onboarding Step-by-Step) -->
        <div id="tourModal" class="fixed inset-0 z-[100] hidden items-center justify-center p-3" style="background: rgba(0,0,0,0.7); backdrop-filter: blur(10px);">
            <div class="glass rounded-3xl p-6 max-w-md w-full relative">
                <!-- Progress Bar -->
                <div class="flex gap-1 mb-6">
                    <div class="tour-progress h-1 bg-emerald-500 rounded-full transition-all" style="width: 25%"></div>
                    <div class="tour-progress h-1 bg-slate-200 rounded-full transition-all" style="width: 25%"></div>
                    <div class="tour-progress h-1 bg-slate-200 rounded-full transition-all" style="width: 25%"></div>
                    <div class="tour-progress h-1 bg-slate-200 rounded-full transition-all" style="width: 25%"></div>
                </div>
                
                <!-- Step 1: Welcome -->
                <div id="tourStep1" class="tour-step text-center">
                    <div class="w-20 h-20 mx-auto mb-4 bg-gradient-to-br from-violet-500 to-fuchsia-500 rounded-2xl flex items-center justify-center text-4xl">
                        ðŸ““
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">Welcome!</h2>
                    <p class="text-slate-600 mb-6">X Journal is a safe place to document your life journey. No ads, no tracking, 100% yours.</p>
                    <div class="bg-gradient-to-br from-violet-100 to-fuchsia-50 rounded-xl p-4 mb-6 text-left border border-violet-200/50">
                        <h3 class="font-semibold text-violet-900 mb-2 text-xs uppercase tracking-wide">âœ¨ Why X Journal?</h3>
                        <p class="text-violet-800 text-sm leading-relaxed">
                            <span class="font-medium">Life moves fast.</span> We often forget how much we've experienced, learned, and achieved. X Journal isn't just a place to writeâ€”it's a <span class="font-semibold">mirror to see the best version of yourself</span> that's been overlooked.
                        </p>
                        <div class="mt-3 pt-3 border-t border-violet-200/50 flex items-center gap-2">
                            <span class="text-lg">ðŸ”’</span>
                            <p class="text-xs text-violet-700">100% private. Your own data, not in the cloud.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Step 2: How it Works -->
                <div id="tourStep2" class="tour-step hidden text-center">
                    <h2 class="text-xl font-bold text-slate-800 mb-3">Cara Pakai</h2>
                    <p class="text-sm text-slate-500 mb-4">Satu menit sehari, seumur hidup memahami diri</p>
                    <div class="space-y-3 mb-6 text-left">
                        <div class="flex items-start gap-3 bg-white/60 rounded-xl p-3 border border-slate-100">
                            <div class="w-9 h-9 bg-gradient-to-br from-emerald-400 to-teal-500 rounded-xl flex items-center justify-center flex-shrink-0 shadow-sm">
                                <span class="text-white font-bold text-sm">1</span>
                            </div>
                            <div>
                                <p class="font-semibold text-slate-800 text-sm">Create Journal</p>
                                <p class="text-xs text-slate-500">Separate stories: work, personal, projects, or daily rants</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3 bg-white/60 rounded-xl p-3 border border-slate-100">
                            <div class="w-9 h-9 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-xl flex items-center justify-center flex-shrink-0 shadow-sm">
                                <span class="text-white font-bold text-sm">2</span>
                            </div>
                            <div>
                                <p class="font-semibold text-slate-800 text-sm">Pick Emoji + Write</p>
                                <p class="text-xs text-slate-500">Choose emoji (or type custom!) + record moments. Your mood is neatly saved.</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3 bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl p-3 border border-amber-200">
                            <div class="w-9 h-9 bg-gradient-to-br from-amber-400 to-orange-500 rounded-xl flex items-center justify-center flex-shrink-0 shadow-sm">
                                <span class="text-white font-bold text-sm">3</span>
                            </div>
                            <div>
                                <p class="font-semibold text-slate-800 text-sm">Lihat Data Analysis â­</p>
                                <p class="text-xs text-slate-500">Menu Database â†’ Data Analysis: see streak, dominant mood, and your journaling patterns!</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 3: Features -->
                <div id="tourStep3" class="tour-step hidden text-center">
                    <h2 class="text-xl font-bold text-slate-800 mb-4">Key Features</h2>
                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <div class="bg-white/60 rounded-xl p-3 text-center">
                            <div class="text-2xl mb-1">ðŸ”’</div>
                            <p class="font-semibold text-slate-800 text-xs">Private</p>
                            <p class="text-[10px] text-slate-500">Local data, not cloud</p>
                        </div>
                        <div class="bg-white/60 rounded-xl p-3 text-center">
                            <div class="text-2xl mb-1">ðŸ˜Š</div>
                            <p class="font-semibold text-slate-800 text-xs">Mood Tracker</p>
                            <p class="text-[10px] text-slate-500">10+ emoji (customizable!)</p>
                        </div>
                        <div class="bg-gradient-to-br from-violet-50 to-fuchsia-50 rounded-xl p-3 text-center border border-violet-200">
                            <div class="text-2xl mb-1">ðŸ“Š</div>
                            <p class="font-semibold text-violet-800 text-xs">Data Analysis â­</p>
                            <p class="text-[10px] text-violet-600">Check the Database menu!</p>
                        </div>
                        <div class="bg-white/60 rounded-xl p-3 text-center">
                            <div class="text-2xl mb-1">ðŸ“±</div>
                            <p class="font-semibold text-slate-800 text-xs">PWA</p>
                            <p class="text-[10px] text-slate-500">Install to homescreen</p>
                        </div>
                    </div>
                </div>
                
                <!-- Step 4: Start Options -->
                <div id="tourStep4" class="tour-step hidden text-center">
                    <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-emerald-400 to-teal-500 rounded-2xl flex items-center justify-center text-3xl">
                        ðŸš€
                    </div>
                    <h2 class="text-xl font-bold text-slate-800 mb-2">Start Your Journey</h2>
                    <p class="text-sm text-slate-600 mb-6">Every entry is an investment in understanding yourself.</p>
                    
                    <div class="space-y-3">
                        <button onclick="closeTour(); showTemplateModal();" class="w-full p-4 bg-gradient-to-r from-violet-50 to-fuchsia-50 border border-violet-200 rounded-xl hover:border-violet-300 transition-all text-left">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">ðŸ“¦</span>
                                <div>
                                    <p class="font-semibold text-slate-800 text-sm">View Template Examples</p>
                                    <p class="text-xs text-slate-500">Choose from different personas</p>
                                </div>
                            </div>
                        </button>
                        
                        <button onclick="closeTour(); document.getElementById('newJournalTitle').focus();" class="w-full p-4 bg-white/60 border border-slate-200 rounded-xl hover:border-slate-300 transition-all text-left">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">âœï¸</span>
                                <div>
                                    <p class="font-semibold text-slate-800 text-sm">Start From Scratch</p>
                                    <p class="text-xs text-slate-500">Create your first journal yourself</p>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
                
                <!-- Navigation Buttons -->
                <div class="flex justify-between mt-6">
                    <button id="tourPrevBtn" onclick="prevTourStep()" class="px-4 py-2 text-slate-500 hover:text-slate-700 text-sm font-medium hidden">
                        â† Back
                    </button>
                    <button id="tourNextBtn" onclick="nextTourStep()" class="flex-1 btn-primary px-6 py-2.5 text-white text-sm font-medium rounded-xl">
                        Next â†’
                    </button>
                    <button id="tourCloseBtn" onclick="closeTour()" class="hidden px-4 py-2 text-slate-500 hover:text-slate-700 text-sm font-medium">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <!-- Template Modal -->
        <div id="templateModal" class="fixed inset-0 z-[100] hidden items-center justify-center p-3" style="background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);" onclick="if(event.target === this) closeTemplateModal()">
            <div class="glass rounded-3xl p-5 md:p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto relative z-[101]" onclick="event.stopPropagation()">
                <div class="text-center mb-6">
                    <div class="w-14 h-14 mx-auto mb-3 rounded-2xl bg-gradient-to-br from-violet-500 to-fuchsia-500 flex items-center justify-center">
                        <span class="text-2xl">ðŸ“¦</span>
                    </div>
                    <h2 class="text-xl font-bold text-slate-800 mb-2">Choose Journal Template</h2>
                    <p class="text-sm text-slate-500">Select the persona that best matches you to get started</p>
                </div>

                <!-- Template Cards Grid -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-5">
                    <!-- Persona Templates -->
                    <div class="col-span-1 sm:col-span-2 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-1">Persona</div>
                    
                    <!-- Mahasiswa -->
                    <div onclick="importTemplateData('dummy-data-mahasiswa.json', 'Mahasiswa')" class="group cursor-pointer bg-gradient-to-br from-emerald-50 to-teal-50 rounded-2xl p-4 border border-emerald-100 hover:border-emerald-300 hover:shadow-lg transition-all hover:-translate-y-1">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-emerald-400 to-teal-500 flex items-center justify-center text-2xl shadow-md group-hover:scale-110 transition-transform">
                                ðŸŽ“
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800">Student</h3>
                                <p class="text-xs text-slate-500">19-24 years</p>
                            </div>
                        </div>
                        <p class="text-sm text-slate-600 mb-3">Journal for college students: thesis, organizations, personal growth, and campus life</p>
                        <div class="flex items-center gap-2 text-xs text-emerald-600 font-medium">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" strokeLinejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            <span>5 Journals â€¢ 19 Entries</span>
                        </div>
                    </div>

                    <!-- Profesional -->
                    <div onclick="importTemplateData('dummy-data-profesional.json', 'Profesional')" class="group cursor-pointer bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-4 border border-blue-100 hover:border-blue-300 hover:shadow-lg transition-all hover:-translate-y-1">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-400 to-indigo-500 flex items-center justify-center text-2xl shadow-md group-hover:scale-110 transition-transform">
                                ðŸ’¼
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800">Profesional</h3>
                                <p class="text-xs text-slate-500">25-35 tahun</p>
                            </div>
                        </div>
                        <p class="text-sm text-slate-600 mb-3">Journal for professionals: career, family, investments, and work-life balance</p>
                        <div class="flex items-center gap-2 text-xs text-blue-600 font-medium">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" strokeLinejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            <span>5 Jurnal â€¢ 25 Entries</span>
                        </div>
                    </div>

                    <!-- Emak2 Olshop -->
                    <div onclick="importTemplateData('dummy-data-emak-olshop.json', 'Emak Olshop')" class="group cursor-pointer bg-gradient-to-br from-rose-50 to-pink-50 rounded-2xl p-4 border border-rose-100 hover:border-rose-300 hover:shadow-lg transition-all hover:-translate-y-1">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-rose-400 to-pink-500 flex items-center justify-center text-2xl shadow-md group-hover:scale-110 transition-transform">
                                ðŸ›ï¸
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800">Online Shop Mom</h3>
                                <p class="text-xs text-slate-500">Entrepreneur</p>
                            </div>
                        </div>
                        <p class="text-sm text-slate-600 mb-3">Journal for online business owners: operations, parenting, suppliers, and community</p>
                        <div class="flex items-center gap-2 text-xs text-rose-600 font-medium">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" strokeLinejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            <span>7 Journals â€¢ 56 Entries</span>
                        </div>
                    </div>

                    <!-- Emak2 Lynk -->
                    <div onclick="importTemplateData('dummy-data-emak-lynk.json', 'Emak Lynk')" class="group cursor-pointer bg-gradient-to-br from-amber-50 to-orange-50 rounded-2xl p-4 border border-amber-100 hover:border-amber-300 hover:shadow-lg transition-all hover:-translate-y-1">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center text-2xl shadow-md group-hover:scale-110 transition-transform">
                                ðŸ’»
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800">Digital Creator Mom</h3>
                                <p class="text-xs text-slate-500">Content Creator</p>
                            </div>
                        </div>
                        <p class="text-sm text-slate-600 mb-3">Creator journal: digital products, marketing, analytics, and community</p>
                        <div class="flex items-center gap-2 text-xs text-amber-600 font-medium">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" strokeLinejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            <span>7 Journals â€¢ 56 Entries</span>
                        </div>
                    </div>

                    <!-- Declutter Mindmap Templates -->
                    <div class="col-span-1 sm:col-span-2 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-1 mt-2">ðŸ§  Brain Declutter (Mindmap)</div>
                    
                    <!-- Mental Load -->
                    <div onclick="importTemplateData('dummy-data-mental-load.json', 'Mental Load')" class="group cursor-pointer bg-gradient-to-br from-violet-50 to-purple-50 rounded-2xl p-4 border border-violet-100 hover:border-violet-300 hover:shadow-lg transition-all hover:-translate-y-1">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-violet-400 to-purple-500 flex items-center justify-center text-2xl shadow-md group-hover:scale-110 transition-transform">
                                ðŸ§ 
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800">Mental Load</h3>
                                <p class="text-xs text-slate-500">Overthinking</p>
                            </div>
                        </div>
                        <p class="text-sm text-slate-600 mb-3">Brain dump, worry list, mind sweep, and mental declutter</p>
                        <div class="flex items-center gap-2 text-xs text-violet-600 font-medium">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" strokeLinejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            <span>7 Journals â€¢ 35 Entries</span>
                        </div>
                    </div>

                    <!-- Emotional Processing -->
                    <div onclick="importTemplateData('dummy-data-emotional-processing.json', 'Emotional')" class="group cursor-pointer bg-gradient-to-br from-pink-50 to-rose-50 rounded-2xl p-4 border border-pink-100 hover:border-pink-300 hover:shadow-lg transition-all hover:-translate-y-1">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-pink-400 to-rose-500 flex items-center justify-center text-2xl shadow-md group-hover:scale-110 transition-transform">
                                ðŸ’­
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800">Emotional</h3>
                                <p class="text-xs text-slate-500">Processing</p>
                            </div>
                        </div>
                        <p class="text-sm text-slate-600 mb-3">Anger release, gratitude, forgiveness, and emotion tracker</p>
                        <div class="flex items-center gap-2 text-xs text-pink-600 font-medium">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" strokeLinejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            <span>7 Journals â€¢ 35 Entries</span>
                        </div>
                    </div>

                    <!-- Decision Making -->
                    <div onclick="importTemplateData('dummy-data-decision-making.json', 'Decision')" class="group cursor-pointer bg-gradient-to-br from-cyan-50 to-blue-50 rounded-2xl p-4 border border-cyan-100 hover:border-cyan-300 hover:shadow-lg transition-all hover:-translate-y-1">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center text-2xl shadow-md group-hover:scale-110 transition-transform">
                                âš–ï¸
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800">Decision</h3>
                                <p class="text-xs text-slate-500">Making</p>
                            </div>
                        </div>
                        <p class="text-sm text-slate-600 mb-3">Pro-con list, 10-10-10 rule, second opinion, decision journal</p>
                        <div class="flex items-center gap-2 text-xs text-cyan-600 font-medium">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" strokeLinejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            <span>7 Journals â€¢ 35 Entries</span>
                        </div>
                    </div>

                    <!-- Creativity -->
                    <div onclick="importTemplateData('dummy-data-creativity-ideas.json', 'Creativity')" class="group cursor-pointer bg-gradient-to-br from-amber-50 to-yellow-50 rounded-2xl p-4 border border-amber-100 hover:border-amber-300 hover:shadow-lg transition-all hover:-translate-y-1">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-amber-400 to-yellow-500 flex items-center justify-center text-2xl shadow-md group-hover:scale-110 transition-transform">
                                ðŸ’¡
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800">Creativity</h3>
                                <p class="text-xs text-slate-500">Ideas</p>
                            </div>
                        </div>
                        <p class="text-sm text-slate-600 mb-3">Morning pages, mind mapping, idea incubator, creative block buster</p>
                        <div class="flex items-center gap-2 text-xs text-amber-600 font-medium">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" strokeLinejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            <span>7 Journals â€¢ 35 Entries</span>
                        </div>
                    </div>

                    <!-- Habits -->
                    <div onclick="importTemplateData('dummy-data-habits-routines.json', 'Habits')" class="group cursor-pointer bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl p-4 border border-green-100 hover:border-green-300 hover:shadow-lg transition-all hover:-translate-y-1">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-400 to-emerald-500 flex items-center justify-center text-2xl shadow-md group-hover:scale-110 transition-transform">
                                ðŸ”„
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800">Habits</h3>
                                <p class="text-xs text-slate-500">Routines</p>
                            </div>
                        </div>
                        <p class="text-sm text-slate-600 mb-3">Habit tracker, routine audit, evening review, weekly reset</p>
                        <div class="flex items-center gap-2 text-xs text-green-600 font-medium">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" strokeLinejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            <span>7 Journals â€¢ 35 Entries</span>
                        </div>
                    </div>

                    <!-- Review -->
                    <div onclick="importTemplateData('dummy-data-review-reflection.json', 'Review')" class="group cursor-pointer bg-gradient-to-br from-indigo-50 to-violet-50 rounded-2xl p-4 border border-indigo-100 hover:border-indigo-300 hover:shadow-lg transition-all hover:-translate-y-1">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-400 to-violet-500 flex items-center justify-center text-2xl shadow-md group-hover:scale-110 transition-transform">
                                ðŸ“Š
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800">Review</h3>
                                <p class="text-xs text-slate-500">Reflection</p>
                            </div>
                        </div>
                        <p class="text-sm text-slate-600 mb-3">Weekly review, quarterly reset, year in review, life audit</p>
                        <div class="flex items-center gap-2 text-xs text-indigo-600 font-medium">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" strokeLinejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            <span>7 Journals â€¢ 35 Entries</span>
                        </div>
                    </div>
                </div>

                <!-- Info Box -->
                <div class="bg-gradient-to-r from-violet-50 to-purple-50 rounded-2xl p-4 border border-violet-100 mb-5">
                    <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded-lg bg-violet-100 flex items-center justify-center flex-shrink-0">
                            <svg class="w-4 h-4 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" strokeLinejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm text-slate-700 font-medium mb-1">Important Tip</p>
                            <p class="text-xs text-slate-600">You can delete this template data anytime via <span class="font-semibold text-slate-800">Database â†’ Reset</span> menu if you want to start from scratch.</p>
                        </div>
                    </div>
                </div>

                <!-- Skip Button -->
                <button onclick="closeTemplateModal()" class="w-full py-3 text-slate-500 hover:text-slate-700 text-sm font-medium transition-colors">
                    Skip, create my own journal â†’
                </button>
            </div>
        </div>

    </main>

    <!-- Milestone Notification (Small, Bottom Right) -->
    <div id="milestoneToast" class="milestone-toast hidden" onclick="handleMilestoneClick()">
        <div class="glass-dark rounded-2xl px-4 py-3 shadow-2xl border border-white/10 milestone-pulse flex items-center gap-3">
            <span id="milestoneIcon" class="text-xl">ðŸŽ‰</span>
            <span id="milestoneText" class="text-sm font-medium text-white">5 entries! Tap me</span>
            <svg class="w-4 h-4 text-white/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </div>
    </div>

    <!-- Milestone Modal -->
    <div id="milestoneModal" class="fixed inset-0 z-[90] hidden modal-overlay items-center justify-center p-3" onclick="if(event.target === this) closeMilestoneModal()">
        <div class="glass rounded-3xl p-6 max-w-md w-full max-h-[85vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="text-center mb-6">
                <div id="milestoneModalIcon" class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-violet-500 to-fuchsia-500 flex items-center justify-center text-3xl shadow-lg">
                    ðŸŽ‰
                </div>
                <h2 id="milestoneModalTitle" class="text-xl font-bold text-slate-800 mb-2">Milestone Reached!</h2>
                <div class="inline-flex items-center gap-2 px-3 py-1 bg-violet-100 rounded-full">
                    <span class="text-xs font-semibold text-violet-700">Entry #<span id="milestoneNumber">5</span></span>
                </div>
            </div>
            
            <div id="milestoneModalContent" class="space-y-4">
                <!-- Content will be injected here -->
            </div>
            
            <button onclick="closeMilestoneModal()" class="w-full mt-6 py-3 btn-primary text-white font-medium rounded-xl">
                Keep Writing âœ¨
            </button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-24 right-4 z-50 transform translate-x-full opacity-0 transition-all duration-300">
        <div class="glass-dark text-slate-100 px-5 py-3 rounded-2xl shadow-2xl flex items-center gap-3">
            <div class="w-6 h-6 rounded-full bg-emerald-500/15 flex items-center justify-center">
                <svg class="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <span id="toastMessage" class="text-sm font-medium">Notification</span>
        </div>
    </div>

    <script>
        // ==================== BACKGROUND IMAGES (27 Pexels Images) ====================
        const NATURE_IMAGES = [
            { id: 'n1', url: 'https://images.pexels.com/photos/1287145/pexels-photo-1287145.jpeg?auto=compress&cs=tinysrgb&w=1920', name: 'Mountain Lake' },
            { id: 'n2', url: 'https://images.pexels.com/photos/417074/pexels-photo-417074.jpeg?auto=compress&cs=tinysrgb&w=1920', name: 'Alpine Lake' },
            { id: 'n3', url: 'https://images.pexels.com/photos/1547813/pexels-photo-1547813.jpeg?auto=compress&cs=tinysrgb&w=1920', name: 'Forest Path' },
            { id: 'n4', url: 'https://images.pexels.com/photos/1770809/pexels-photo-1770809.jpeg?auto=compress&cs=tinysrgb&w=1920', name: 'Sunset Beach' },
            { id: 'n5', url: 'https://images.pexels.com/photos/2662116/pexels-photo-2662116.jpeg?auto=compress&cs=tinysrgb&w=1920', name: 'Moraine Lake' },
            { id: 'n6', url: 'https://images.pexels.com/photos/3408744/pexels-photo-3408744.jpeg?auto=compress&cs=tinysrgb&w=1920', name: 'Northern Lights' },
            { id: 'n7', url: 'https://images.pexels.com/photos/3244513/pexels-photo-3244513.jpeg?auto=compress&cs=tinysrgb&w=1920', name: 'Desert Dunes' },
            { id: 'n8', url: 'https://images.pexels.com/photos/1647972/pexels-photo-1647972.jpeg?auto=compress&cs=tinysrgb&w=1920', name: 'Starry Night' },
            { id: 'n9', url: 'https://images.pexels.com/photos/2258536/pexels-photo-2258536.jpeg?auto=compress&cs=tinysrgb&w=1920', name: 'Waterfall' },
            { id: 'n10', url: 'https://images.pexels.com/photos/3293148/pexels-photo-3293148.jpeg?auto=compress&cs=tinysrgb&w=1920', name: 'Ocean Waves' },
            { id: 'n11', url: 'https://images.pexels.com/photos/1327373/pexels-photo-1327373.jpeg?auto=compress&cs=tinysrgb&w=1920', name: 'Bamboo Forest' },
            { id: 'n12', url: 'https://images.pexels.com/photos/1761279/pexels-photo-1761279.jpeg?auto=compress&cs=tinysrgb&w=1920', name: 'Cherry Blossom' },
            { id: 'n13', url: 'https://images.pexels.com/photos/1485894/pexels-photo-1485894.jpeg?auto=compress&cs=tinysrgb&w=1920', name: 'Palm Trees' },
            { id: 'n14', url: 'https://images.pexels.com/photos/1028225/pexels-photo-1028225.jpeg?auto=compress&cs=tinysrgb&w=1920', name: 'Green Hills' }
        ];
        
        const CITY_IMAGES = [
            { id: 'c1', url: 'https://images.pexels.com/photos/313782/pexels-photo-313782.jpeg?auto=compress&cs=tinysrgb&w=1920', name: 'New York Skyline' },
            { id: 'c2', url: 'https://images.pexels.com/photos/1470405/pexels-photo-1470405.jpeg?auto=compress&cs=tinysrgb&w=1920', name: 'Tokyo Night' },
            { id: 'c3', url: 'https://images.pexels.com/photos/302769/pexels-photo-302769.jpeg?auto=compress&cs=tinysrgb&w=1920', name: 'City Architecture' },
            { id: 'c4', url: 'https://images.pexels.com/photos/169647/pexels-photo-169647.jpeg?auto=compress&cs=tinysrgb&w=1920', name: 'City at Night' },
            { id: 'c5', url: 'https://images.pexels.com/photos/466685/pexels-photo-466685.jpeg?auto=compress&cs=tinysrgb&w=1920', name: 'Skyscrapers' },
            { id: 'c6', url: 'https://images.pexels.com/photos/1181244/pexels-photo-1181244.jpeg?auto=compress&cs=tinysrgb&w=1920', name: 'Modern Building' },
            { id: 'c7', url: 'https://images.pexels.com/photos/290595/pexels-photo-290595.jpeg?auto=compress&cs=tinysrgb&w=1920', name: 'Bridge View' },
            { id: 'c8', url: 'https://images.pexels.com/photos/1123972/pexels-photo-1123972.jpeg?auto=compress&cs=tinysrgb&w=1920', name: 'Urban Night' },
            { id: 'c9', url: 'https://images.pexels.com/photos/1486222/pexels-photo-1486222.jpeg?auto=compress&cs=tinysrgb&w=1920', name: 'City Skyline' },
            { id: 'c10', url: 'https://images.pexels.com/photos/325185/pexels-photo-325185.jpeg?auto=compress&cs=tinysrgb&w=1920', name: 'Downtown' },
            { id: 'c11', url: 'https://images.pexels.com/photos/219692/pexels-photo-219692.jpeg?auto=compress&cs=tinysrgb&w=1920', name: 'City Lights' },
            { id: 'c12', url: 'https://images.pexels.com/photos/196644/pexels-photo-196644.jpeg?auto=compress&cs=tinysrgb&w=1920', name: 'Empire State' },
            { id: 'c13', url: 'https://images.pexels.com/photos/373912/pexels-photo-373912.jpeg?auto=compress&cs=tinysrgb&w=1920', name: 'Building Detail' }
        ];
        
        let currentBgType = 'gradient';
        let currentBgImage = null;
        
        // Initialize background selector
        function initBackgroundSelector() {
            const natureGrid = document.getElementById('natureGrid');
            const cityGrid = document.getElementById('cityGrid');
            
            NATURE_IMAGES.forEach(img => {
                const div = document.createElement('div');
                div.className = 'bg-option w-full aspect-square rounded-xl overflow-hidden shadow-md border border-slate-200';
                div.style.backgroundImage = `url(${img.url})`;
                div.style.backgroundSize = 'cover';
                div.style.backgroundPosition = 'center';
                div.id = `bg-${img.id}`;
                div.onclick = () => setBackground('image', img.url, img.id);
                div.title = img.name;
                natureGrid.appendChild(div);
            });
            
            CITY_IMAGES.forEach(img => {
                const div = document.createElement('div');
                div.className = 'bg-option w-full aspect-square rounded-xl overflow-hidden shadow-md border border-slate-200';
                div.style.backgroundImage = `url(${img.url})`;
                div.style.backgroundSize = 'cover';
                div.style.backgroundPosition = 'center';
                div.id = `bg-${img.id}`;
                div.onclick = () => setBackground('image', img.url, img.id);
                div.title = img.name;
                cityGrid.appendChild(div);
            });
        }
        
        function openBgModal() {
            document.getElementById('bgModal').classList.remove('hidden');
            document.getElementById('bgModal').classList.add('flex');
        }
        
        function closeBgModal() {
            document.getElementById('bgModal').classList.add('hidden');
            document.getElementById('bgModal').classList.remove('flex');
        }
        
        // ==================== ANALYTICS ====================
        function openAnalyticsModal() {
            document.getElementById('analyticsModal').classList.remove('hidden');
            document.getElementById('analyticsModal').classList.add('flex');
            calculateAnalytics();
        }
        
        function closeAnalyticsModal() {
            document.getElementById('analyticsModal').classList.add('hidden');
            document.getElementById('analyticsModal').classList.remove('flex');
        }
        
        // ==================== RESET DATA ====================
        function openResetModal() {
            document.getElementById('resetModal').classList.remove('hidden');
            document.getElementById('resetModal').classList.add('flex');
            // Reset checkbox state
            document.getElementById('resetConfirmCheckbox').checked = false;
            toggleResetButton();
        }
        
        function closeResetModal() {
            document.getElementById('resetModal').classList.add('hidden');
            document.getElementById('resetModal').classList.remove('flex');
        }
        
        function toggleResetButton() {
            const checkbox = document.getElementById('resetConfirmCheckbox');
            const btn = document.getElementById('resetConfirmBtn');
            if (checkbox.checked) {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.classList.add('hover:bg-red-600');
            } else {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                btn.classList.remove('hover:bg-red-600');
            }
        }
        
        async function resetAllData() {
            try {
                const transaction = db.transaction([PARENT_STORE, CHILD_STORE], 'readwrite');
                const parentStore = transaction.objectStore(PARENT_STORE);
                const childStore = transaction.objectStore(CHILD_STORE);
                
                await new Promise((resolve, reject) => {
                    const r = parentStore.clear();
                    r.onsuccess = () => resolve();
                    r.onerror = () => reject(r.error);
                });
                
                await new Promise((resolve, reject) => {
                    const r = childStore.clear();
                    r.onsuccess = () => resolve();
                    r.onerror = () => reject(r.error);
                });
                
                closeResetModal();
                showToast('Semua data telah dihapus');
                
                // Reset milestone tracking
                MILESTONES.forEach(m => localStorage.removeItem(`milestone_shown_${m}`));
                
                await renderJournals();
            } catch (error) {
                console.error('Error resetting data:', error);
                showToast('Gagal menghapus data');
            }
        }
        
        // ==================== ONBOARDING & TOUR ====================
        let currentTourStep = 1;
        const totalTourSteps = 4;
        
        function startTour() {
            currentTourStep = 1;
            document.getElementById('tourModal').classList.remove('hidden');
            document.getElementById('tourModal').classList.add('flex');
            document.querySelector('header').classList.add('hidden');
            updateTourUI();
        }
        
        function closeTour() {
            document.getElementById('tourModal').classList.add('hidden');
            document.getElementById('tourModal').classList.remove('flex');
            document.querySelector('header').classList.remove('hidden');
            // Reset to step 1 for next time
            currentTourStep = 1;
        }
        
        function nextTourStep() {
            if (currentTourStep < totalTourSteps) {
                currentTourStep++;
                updateTourUI();
            }
        }
        
        function prevTourStep() {
            if (currentTourStep > 1) {
                currentTourStep--;
                updateTourUI();
            }
        }
        
        function updateTourUI() {
            // Hide all steps
            document.querySelectorAll('.tour-step').forEach(el => el.classList.add('hidden'));
            // Show current step
            document.getElementById(`tourStep${currentTourStep}`).classList.remove('hidden');
            
            // Update progress bar
            const progressBars = document.querySelectorAll('.tour-progress');
            progressBars.forEach((bar, index) => {
                if (index < currentTourStep) {
                    bar.classList.remove('bg-slate-200');
                    bar.classList.add('bg-emerald-500');
                } else {
                    bar.classList.add('bg-slate-200');
                    bar.classList.remove('bg-emerald-500');
                }
            });
            
            // Update buttons
            const prevBtn = document.getElementById('tourPrevBtn');
            const nextBtn = document.getElementById('tourNextBtn');
            
            if (currentTourStep === 1) {
                prevBtn.classList.add('hidden');
                nextBtn.classList.remove('hidden');
                nextBtn.textContent = 'Lanjut â†’';
            } else if (currentTourStep === totalTourSteps) {
                prevBtn.classList.remove('hidden');
                nextBtn.classList.add('hidden');
            } else {
                prevBtn.classList.remove('hidden');
                nextBtn.classList.remove('hidden');
                nextBtn.textContent = 'Lanjut â†’';
            }
        }
        
        function showTemplateModal() {
            document.getElementById('templateModal').classList.remove('hidden');
            document.getElementById('templateModal').classList.add('flex');
            document.querySelector('header').classList.add('hidden');
        }
        
        function closeTemplateModal() {
            document.getElementById('templateModal').classList.add('hidden');
            document.getElementById('templateModal').classList.remove('flex');
            document.querySelector('header').classList.remove('hidden');
        }
        
        async function importTemplateData(url, templateName) {
            try {
                showToast(`Mengambil data ${templateName}...`);
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch');
                const data = await response.json();
                
                // Import parents
                const transaction = db.transaction([PARENT_STORE, CHILD_STORE], 'readwrite');
                const parentStore = transaction.objectStore(PARENT_STORE);
                const childStore = transaction.objectStore(CHILD_STORE);
                
                // Clear existing data first
                await new Promise((resolve, reject) => {
                    const r = parentStore.clear();
                    r.onsuccess = () => resolve();
                    r.onerror = () => reject(r.error);
                });
                await new Promise((resolve, reject) => {
                    const r = childStore.clear();
                    r.onsuccess = () => resolve();
                    r.onerror = () => reject(r.error);
                });
                
                // Add parents
                for (const parent of data.parents) {
                    await new Promise((resolve, reject) => {
                        const r = parentStore.add(parent);
                        r.onsuccess = () => resolve();
                        r.onerror = () => reject(r.error);
                    });
                }
                
                // Add children
                for (const child of data.children) {
                    await new Promise((resolve, reject) => {
                        const r = childStore.add(child);
                        r.onsuccess = () => resolve();
                        r.onerror = () => reject(r.error);
                    });
                }
                
                closeTemplateModal();
                showToast(`Template ${templateName} berhasil diimport!`);
                await renderJournals();
            } catch (error) {
                console.error('Error importing template:', error);
                showToast('Gagal mengambil data. Cek koneksi internet.');
            }
        }
        
        // ==================== JOURNALING COACH ====================
        let currentCoachStep = 0;
        let coachSteps = [];
        
        function initCoachSteps() {
            coachSteps = [
                {
                    title: 'Welcome! ðŸŽ‰',
                    content: 'X Journal is your place to record thoughts, feelings, and important moments. All data is stored locally on your device.',
                    target: null,
                    position: 'center'
                },
                {
                    title: 'Create New Journal ðŸ“',
                    content: 'Click this button to create a new journal. Journals can be for any topic: work, personal, projects, or your daily diary.',
                    target: '#newJournalBtn',
                    position: 'bottom'
                },
                {
                    title: 'Change Background ðŸŽ¨',
                    content: 'Choose a theme that matches your mood! There are gradients, nature, textures, and abstract. All free.',
                    target: '#bgMenuContainer button',
                    position: 'bottom'
                },
                {
                    title: 'Menu Database ðŸ’¾',
                    content: 'This is where you manage data: Import, Export, Data Analysis, Journaling Coach (this!), and Reset Data.',
                    target: '#dataMenuContainer button',
                    position: 'bottom'
                },
                {
                    title: 'Import Data ðŸ“¥',
                    content: 'Have a backup? Import JSON file to restore your journal. Old data will be replaced.',
                    target: null,
                    position: 'center'
                },
                {
                    title: 'Export Data ðŸ“¤',
                    content: 'Backup your journal to JSON file. Recommended to do regularly for data security.',
                    target: null,
                    position: 'center'
                },
                {
                    title: 'Data Analysis ðŸ“Š [IMPORTANT!]',
                    content: 'This is a powerful hidden feature! Click Database menu â†’ Data Analysis to see: journaling streak, dominant mood, activity rate, and insights. PWA install tips included too!',
                    target: '#dataMenuContainer button',
                    position: 'bottom'
                },
                {
                    title: 'Reset Data âš ï¸',
                    content: 'Delete ALL journal data. Need checkbox confirmation to prevent accidents. Make sure to export first!',
                    target: null,
                    position: 'center'
                },
                {
                    title: 'Journal Card ðŸ““',
                    content: 'Each journal has a cover emoji, title, description, and entry count. Click to open/close.',
                    target: '.journal-card',
                    position: 'top'
                },
                {
                    title: 'Add Entry âž•',
                    content: 'Click the + button to scroll directly to the entry form. You can choose mood, upload images, and write notes!',
                    target: '.new-entry-btn',
                    position: 'left'
                },
                {
                    title: 'Pick Emoji Mood ðŸ˜Š [CUSTOMIZABLE!]',
                    content: 'Choose default emoji or type custom emoji (click "+ Add"). Your mood will be recorded and appear in Data Analysis as dominant mood stats!',
                    target: '.emoji-btn',
                    position: 'bottom'
                },
                {
                    title: 'Upload Image ðŸ“¸',
                    content: 'You can add images to entries. Images are uploaded to ImgBB (never deleted) and the URL is saved in the entry.',
                    target: null,
                    position: 'center'
                },
                {
                    title: 'Write Notes ðŸ“',
                    content: 'Write anything you want to record. Auto-detects URL links (will become clickable buttons).',
                    target: null,
                    position: 'center'
                },
                {
                    title: 'Add Entry Button âœ¨',
                    content: 'Click to save the entry. After that, the entry will appear in the list and auto-scroll to the new entry.',
                    target: null,
                    position: 'center'
                },
                {
                    title: 'Entry Card ðŸŽ´',
                    content: 'Entry displays mood emoji, note content (with clickable links), image (if any), and timestamp.',
                    target: '.entry-card',
                    position: 'top'
                },
                {
                    title: 'Pro Tips ðŸ’¡',
                    content: 'Use persona templates during onboarding to instantly have ready-to-use journals. Can also be accessed via Reset â†’ Template.',
                    target: null,
                    position: 'center'
                },
                {
                    title: 'Ready to Start! ðŸš€',
                    content: "That's all X Journal features. Start creating your first journal and happy journaling! Remember: consistency is key.",
                    target: null,
                    position: 'center'
                }
            ];
        }
        
        function startJournalingCoach() {
            initCoachSteps();
            currentCoachStep = 0;
            document.getElementById('coachContainer').classList.remove('hidden');
            showCoachStep();
            
            // Update on resize/scroll
            window.addEventListener('resize', updateCoachPosition);
            window.addEventListener('scroll', updateCoachPosition, true);
        }
        
        function endCoach() {
            document.getElementById('coachContainer').classList.add('hidden');
            window.removeEventListener('resize', updateCoachPosition);
            window.removeEventListener('scroll', updateCoachPosition, true);
            showToast('Tour completed! Hope it helps ðŸŽ‰');
        }
        
        function updateCoachPosition() {
            if (document.getElementById('coachContainer').classList.contains('hidden')) return;
            showCoachStep();
        }
        
        function showCoachStep() {
            const step = coachSteps[currentCoachStep];
            const tooltip = document.getElementById('coachTooltip');
            const cutout = document.getElementById('coachCutout');
            const stepNumber = document.getElementById('coachStepNumber');
            const progressDots = document.getElementById('coachProgressDots');
            
            // Update content
            document.getElementById('coachTitle').textContent = step.title;
            document.getElementById('coachContent').textContent = step.content;
            
            // Update progress
            stepNumber.textContent = `Step ${currentCoachStep + 1}/${coachSteps.length}`;
            
            // Show max 8 dots
            const visibleDots = Math.min(coachSteps.length, 8);
            const startIdx = Math.max(0, Math.min(currentCoachStep - 4, coachSteps.length - 8));
            progressDots.innerHTML = Array.from({length: visibleDots}, (_, i) => {
                const idx = startIdx + i;
                const isActive = idx === currentCoachStep;
                const isPast = idx < currentCoachStep;
                return `<div class="w-1.5 h-1.5 rounded-full transition-colors ${isActive ? 'bg-emerald-500' : isPast ? 'bg-emerald-200' : 'bg-slate-200'}"></div>`;
            }).join('');
            
            // Update buttons
            document.getElementById('coachPrevBtn').style.visibility = currentCoachStep === 0 ? 'hidden' : 'visible';
            document.getElementById('coachNextBtn').textContent = currentCoachStep === coachSteps.length - 1 ? 'Selesai' : 'Next';
            
            // Position tooltip and cutout
            if (step.target) {
                const targetEl = document.querySelector(step.target);
                if (targetEl) {
                    const rect = targetEl.getBoundingClientRect();
                    const padding = 8;
                    
                    // Update SVG cutout
                    cutout.setAttribute('x', rect.left - padding);
                    cutout.setAttribute('y', rect.top - padding);
                    cutout.setAttribute('width', rect.width + padding * 2);
                    cutout.setAttribute('height', rect.height + padding * 2);
                    
                    // Position tooltip
                    positionCoachTooltip(tooltip, rect, step.position);
                } else {
                    // Target not found, hide cutout and center tooltip
                    cutout.setAttribute('width', '0');
                    cutout.setAttribute('height', '0');
                    centerCoachTooltip(tooltip);
                }
            } else {
                // No target, hide cutout and center tooltip
                cutout.setAttribute('width', '0');
                cutout.setAttribute('height', '0');
                centerCoachTooltip(tooltip);
            }
        }
        
        function positionCoachTooltip(tooltip, targetRect, position) {
            const tooltipRect = tooltip.getBoundingClientRect();
            const spacing = 12;
            const padding = 16;
            
            let left, top;
            
            switch (position) {
                case 'bottom':
                    left = targetRect.left + (targetRect.width - tooltipRect.width) / 2;
                    top = targetRect.bottom + spacing;
                    break;
                case 'top':
                    left = targetRect.left + (targetRect.width - tooltipRect.width) / 2;
                    top = targetRect.top - tooltipRect.height - spacing;
                    break;
                case 'left':
                    left = targetRect.left - tooltipRect.width - spacing;
                    top = targetRect.top + (targetRect.height - tooltipRect.height) / 2;
                    break;
                case 'right':
                    left = targetRect.right + spacing;
                    top = targetRect.top + (targetRect.height - tooltipRect.height) / 2;
                    break;
                default:
                    left = (window.innerWidth - tooltipRect.width) / 2;
                    top = (window.innerHeight - tooltipRect.height) / 2;
            }
            
            // Keep within viewport
            left = Math.max(padding, Math.min(left, window.innerWidth - tooltipRect.width - padding));
            top = Math.max(padding, Math.min(top, window.innerHeight - tooltipRect.height - padding));
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            tooltip.style.transform = 'none';
        }
        
        function centerCoachTooltip(tooltip) {
            tooltip.style.left = '50%';
            tooltip.style.top = '50%';
            tooltip.style.transform = 'translate(-50%, -50%)';
        }
        
        function nextCoachStep() {
            if (currentCoachStep < coachSteps.length - 1) {
                currentCoachStep++;
                showCoachStep();
            } else {
                endCoach();
            }
        }
        
        function prevCoachStep() {
            if (currentCoachStep > 0) {
                currentCoachStep--;
                showCoachStep();
            }
        }
        
        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // Close milestone modal if open
                const milestoneModal = document.getElementById('milestoneModal');
                if (!milestoneModal.classList.contains('hidden')) {
                    closeMilestoneModal();
                    return;
                }
                // End coach if active
                if (!document.getElementById('coachContainer').classList.contains('hidden')) {
                    endCoach();
                    return;
                }
            }
            
            if (document.getElementById('coachContainer').classList.contains('hidden')) return;
            if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextCoachStep();
            } else if (e.key === 'ArrowLeft') {
                e.preventDefault();
                prevCoachStep();
            }
        });
        
        // ==================== PWA INSTALL ====================
        let deferredPrompt = null;
        let pwaInstallReady = false;
        
        function initPWAInstall() {
            const installBtn = document.getElementById('installPwaBtn');
            const iosHint = document.getElementById('iosInstallHint');
            const androidHint = document.getElementById('androidInstallHint');
            
            if (!installBtn) return;
            
            // Check if already installed
            const isInstalled = window.matchMedia('(display-mode: standalone)').matches || 
                               window.navigator.standalone === true;
            
            // Detect iOS
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            
            // Hide button initially until we know it can be installed
            installBtn.style.opacity = '0.5';
            
            // Listen for install prompt
            window.addEventListener('beforeinstallprompt', (e) => {
                console.log('beforeinstallprompt fired');
                e.preventDefault();
                deferredPrompt = e;
                pwaInstallReady = true;
                installBtn.style.opacity = '1';
                installBtn.textContent = 'Install';
                installBtn.classList.remove('bg-gray-400');
                installBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
            });
            
            // If already installed
            if (isInstalled) {
                installBtn.style.display = 'none';
                const subtitle = installBtn.parentElement.querySelector('p.text-xs');
                if (subtitle) subtitle.textContent = 'X Journal terinstall';
                return;
            }
            
            window.installPWA = function() {
                // Close analytics modal first so PWA prompt can be seen
                closeAnalyticsModal();
                
                if (isIOS) {
                    iosHint.classList.remove('hidden');
                    if (androidHint) androidHint.classList.add('hidden');
                    return;
                }
                
                if (deferredPrompt) {
                    // Small delay to let modal close animation finish
                    setTimeout(() => {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then((choiceResult) => {
                            if (choiceResult.outcome === 'accepted') {
                                showToast('X Journal diinstall!');
                            } else {
                                showToast('Install dibatalkan');
                            }
                            deferredPrompt = null;
                        }).catch((err) => {
                            console.error('Install error:', err);
                            showToast('Gagal install, coba lagi');
                        });
                    }, 300);
                } else {
                    // Hide iOS hint, show Android hint
                    if (iosHint) iosHint.classList.add('hidden');
                    if (androidHint) androidHint.classList.remove('hidden');
                    
                    // Check if running from file:// protocol
                    const isFileProtocol = window.location.protocol === 'file:';
                    const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                    
                    if (isFileProtocol) {
                        // File opened locally - PWA install blocked by Chrome
                        showToast('Install via menu Chrome â‹® â†’ Install');
                    } else if (!isLocalhost && !window.location.protocol.includes('https')) {
                        showToast('PWA membutuhkan HTTPS atau localhost');
                    } else if (!pwaInstallReady) {
                        showToast('Tap menu Chrome â‹® â†’ Install app');
                    }
                }
            };
            
            // For browsers that don't fire beforeinstallprompt (like some Chrome versions)
            // Show button after a delay with alternative instructions
            setTimeout(() => {
                if (!pwaInstallReady && !isInstalled) {
                    installBtn.style.opacity = '1';
                    installBtn.title = 'Tap untuk instruksi install';
                }
            }, 2000);
        }
        
        function getDaysDiff(date1, date2) {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            d1.setHours(0, 0, 0, 0);
            d2.setHours(0, 0, 0, 0);
            return Math.floor((d2 - d1) / (1000 * 60 * 60 * 24));
        }
        
        function formatDaysAgo(days) {
            if (days === 0) return 'Today';
            if (days === 1) return 'Yesterday';
            return `${days} days ago`;
        }
        
        async function calculateAnalytics() {
            const transaction = db.transaction([CHILD_STORE, PARENT_STORE], 'readonly');
            const childStore = transaction.objectStore(CHILD_STORE);
            const parentStore = transaction.objectStore(PARENT_STORE);
            
            const allChildren = await new Promise((resolve, reject) => {
                const request = childStore.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
            
            const allParents = await new Promise((resolve, reject) => {
                const request = parentStore.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
            
            if (allChildren.length === 0) {
                document.getElementById('analyticsContent').innerHTML = `
                    <div class="col-span-2 text-center py-8">
                        <div class="w-14 h-14 mx-auto mb-3 rounded-2xl bg-slate-100 flex items-center justify-center">
                            <span class="text-2xl">ðŸ“Š</span>
                        </div>
                        <p class="text-slate-500 text-sm">No data yet</p>
                        <p class="text-slate-400 text-xs mt-1">Start journaling to see statistics</p>
                    </div>
                `;
                return;
            }
            
            // Sort by date descending
            const sortedChildren = [...allChildren].sort((a, b) => b.dateAdded - a.dateAdded);
            
            // 1. Last Entry (Days ago)
            const lastEntryDate = new Date(sortedChildren[0].dateAdded);
            const today = new Date();
            const daysSinceLastEntry = getDaysDiff(lastEntryDate, today);
            
            // 2. Current Streak
            const entryDates = [...new Set(allChildren.map(c => {
                const d = new Date(c.dateAdded);
                d.setHours(0, 0, 0, 0);
                return d.getTime();
            }))].sort((a, b) => b - a);
            
            let currentStreak = 0;
            let checkDate = new Date();
            checkDate.setHours(0, 0, 0, 0);
            
            for (let i = 0; i < entryDates.length; i++) {
                const entryDate = new Date(entryDates[i]);
                const diff = getDaysDiff(entryDate, checkDate);
                if (diff <= 1) {
                    currentStreak++;
                    checkDate = entryDate;
                } else {
                    break;
                }
            }
            
            // 3. Longest Streak
            let longestStreak = 1;
            let tempStreak = 1;
            const sortedDatesAsc = [...entryDates].sort((a, b) => a - b);
            
            for (let i = 1; i < sortedDatesAsc.length; i++) {
                const prev = new Date(sortedDatesAsc[i - 1]);
                const curr = new Date(sortedDatesAsc[i]);
                const diff = getDaysDiff(prev, curr);
                if (diff === 1) {
                    tempStreak++;
                    longestStreak = Math.max(longestStreak, tempStreak);
                } else {
                    tempStreak = 1;
                }
            }
            
            // 4. Max entries in one day
            const entriesPerDay = {};
            allChildren.forEach(c => {
                const d = new Date(c.dateAdded);
                const key = `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
                entriesPerDay[key] = (entriesPerDay[key] || 0) + 1;
            });
            const maxEntriesInDay = Math.max(...Object.values(entriesPerDay));
            const maxEntriesDate = Object.entries(entriesPerDay)
                .sort((a, b) => b[1] - a[1])[0];
            
            // 5. Total entries
            const totalEntries = allChildren.length;
            
            // 6. Total journals
            const totalJournals = allParents.length;
            
            // 7. Most active journal
            const entriesPerJournal = {};
            allChildren.forEach(c => {
                entriesPerJournal[c.parentId] = (entriesPerJournal[c.parentId] || 0) + 1;
            });
            const mostActiveJournalId = Object.entries(entriesPerJournal)
                .sort((a, b) => b[1] - a[1])[0]?.[0];
            const mostActiveJournal = allParents.find(p => p.id === mostActiveJournalId);
            
            // 8. Most used mood
            const moodCount = {};
            allChildren.forEach(c => {
                moodCount[c.emoticon] = (moodCount[c.emoticon] || 0) + 1;
            });
            const mostUsedMood = Object.entries(moodCount)
                .sort((a, b) => b[1] - a[1])[0];
            
            // 9. Average entries per active day
            const avgEntriesPerDay = (totalEntries / entryDates.length).toFixed(1);
            
            // 10. First entry date
            const firstEntry = sortedChildren[sortedChildren.length - 1];
            const firstEntryDate = new Date(firstEntry.dateAdded);
            const daysSinceFirst = getDaysDiff(firstEntryDate, today);
            
            // 11. Activity rate (active days / total days since first entry)
            const activityRate = Math.round((entryDates.length / (daysSinceFirst + 1)) * 100);
            
            // Generate HTML - Compact Grid Layout
            const stats = [
                {
                    icon: 'ðŸ”¥',
                    label: 'Streak',
                    value: `${currentStreak}`,
                    unit: 'days',
                    color: 'from-orange-500 to-red-500',
                    bgColor: 'bg-orange-50'
                },
                {
                    icon: 'ðŸ“…',
                    label: 'Last',
                    value: daysSinceLastEntry === 0 ? 'Today' : daysSinceLastEntry === 1 ? 'Yesterday' : `${daysSinceLastEntry}d`,
                    unit: '',
                    color: 'from-blue-500 to-cyan-500',
                    bgColor: 'bg-blue-50'
                },
                {
                    icon: 'ðŸ†',
                    label: 'Best Streak',
                    value: `${longestStreak}`,
                    unit: 'days',
                    color: 'from-amber-500 to-yellow-500',
                    bgColor: 'bg-amber-50'
                },
                {
                    icon: 'âš¡',
                    label: 'Max Entry/Day',
                    value: `${maxEntriesInDay}`,
                    unit: 'entry',
                    color: 'from-violet-500 to-purple-500',
                    bgColor: 'bg-violet-50'
                },
                {
                    icon: 'ðŸ“',
                    label: 'Total Entry',
                    value: `${totalEntries}`,
                    unit: '',
                    color: 'from-emerald-500 to-teal-500',
                    bgColor: 'bg-emerald-50'
                },
                {
                    icon: 'ðŸ“Š',
                    label: 'Average',
                    value: avgEntriesPerDay,
                    unit: '/day',
                    color: 'from-indigo-500 to-blue-500',
                    bgColor: 'bg-indigo-50'
                },
                {
                    icon: 'ðŸŽ¯',
                    label: 'Activity',
                    value: `${activityRate}`,
                    unit: '%',
                    color: 'from-rose-500 to-pink-500',
                    bgColor: 'bg-rose-50'
                },
                {
                    icon: 'ðŸ“š',
                    label: 'Journals',
                    value: `${totalJournals}`,
                    unit: '',
                    color: 'from-cyan-500 to-sky-500',
                    bgColor: 'bg-cyan-50'
                },
                {
                    icon: mostUsedMood ? mostUsedMood[0] : 'ðŸ˜Š',
                    label: 'Top Mood',
                    value: mostUsedMood ? `${mostUsedMood[1]}` : '-',
                    unit: 'x',
                    color: 'from-fuchsia-500 to-pink-500',
                    bgColor: 'bg-fuchsia-50'
                },
                {
                    icon: 'ðŸš€',
                    label: 'Started',
                    value: `${daysSinceFirst}`,
                    unit: 'd ago',
                    color: 'from-lime-500 to-green-500',
                    bgColor: 'bg-lime-50'
                }
            ];
            
            document.getElementById('analyticsContent').innerHTML = stats.map((stat, i) => `
                <div class="${stat.bgColor} rounded-2xl p-2 md:p-3 hover:scale-[1.03] transition-transform duration-200 border border-white/50 shadow-sm overflow-hidden" style="animation: slideUpFade 0.3s ease ${i * 0.03}s both; min-width: 0;">
                    <div class="flex items-center gap-2 overflow-hidden">
                        <div class="w-8 h-8 md:w-10 md:h-10 rounded-xl bg-gradient-to-br ${stat.color} flex items-center justify-center text-lg md:text-xl shadow-md flex-shrink-0">
                            ${stat.icon}
                        </div>
                        <div class="min-w-0 flex-1 overflow-hidden">
                            <p class="text-[10px] md:text-xs text-slate-500 font-medium leading-tight truncate">${stat.label}</p>
                            <p class="text-sm md:text-lg font-bold text-slate-800 leading-tight truncate">${stat.value}<span class="text-[10px] md:text-xs font-normal text-slate-500 ml-0.5">${stat.unit}</span></p>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Update quote based on activity
            const quotes = [
                "Konsistensi adalah kunci mastering.",
                "Setiap entry adalah langkah menuju pemahaman diri.",
                "Journaling adalah investasi untuk masa depan.",
                "Kebiasaan kecil menciptakan perubahan besar.",
                "Dokumentasikan perjalananmu, hargai prosesnya."
            ];
            document.getElementById('analyticsQuote').textContent = `"${quotes[Math.floor(Math.random() * quotes.length)]}"`;
        }
        
        const GRADIENT_CLASSES = ['gradient-purple', 'gradient-black-red', 'gradient-ocean', 'gradient-sunset', 'gradient-forest', 'gradient-cosmic', 'gradient-midnight', 'gradient-candy', 'gradient-aurora', 'gradient-neon', 'gradient-gold', 'gradient-berry', 'gradient-sherbet', 'gradient-oceanic'];
        
        function setBackground(type, gradientVariant, elementId) {
            const body = document.body;
            const ambientBg = document.getElementById('ambientBg');
            
            // Remove previous selections
            document.querySelectorAll('.bg-option').forEach(el => el.classList.remove('selected'));
            
            // Remove all gradient classes
            GRADIENT_CLASSES.forEach(cls => body.classList.remove(cls));
            
            if (type === 'gradient') {
                const gradientClass = `gradient-${gradientVariant || 'purple'}`;
                body.className = `bg-gradient antialiased ${gradientClass}`;
                body.style.backgroundImage = '';
                ambientBg.classList.remove('hidden');
                
                if (elementId) {
                    document.getElementById(`bg-${elementId}`).classList.add('selected');
                } else {
                    document.getElementById('bg-g-purple').classList.add('selected');
                }
                
                currentBgType = 'gradient';
                currentBgImage = gradientVariant || 'purple';
            } else {
                body.className = 'bg-image antialiased';
                body.style.backgroundImage = `url(${gradientVariant})`; // gradientVariant is imageUrl here
                ambientBg.classList.add('hidden');
                if (elementId) {
                    document.getElementById(`bg-${elementId}`).classList.add('selected');
                }
                currentBgType = 'image';
                currentBgImage = gradientVariant; // imageUrl
            }
            
            // Save preference
            localStorage.setItem('journalBgType', type);
            localStorage.setItem('journalBgVariant', currentBgImage || '');
        }
        
        // ==================== DATABASE (same as before) ====================
        const DB_NAME = 'JournalingAppDB';
        const DB_VERSION = 1;
        const PARENT_STORE = 'parents';
        const CHILD_STORE = 'children';
        let db = null;
        const EMOTICONS = ['ðŸ˜Š', 'ðŸ˜¢', 'ðŸ˜¡', 'ðŸ˜°', 'ðŸ¤”', 'ðŸ¥°', 'ðŸ˜´', 'ðŸ¤©', 'ðŸ˜Ž', 'ðŸ¤¯'];
        
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => { db = request.result; resolve(db); };
                request.onupgradeneeded = (event) => {
                    const database = event.target.result;
                    if (!database.objectStoreNames.contains(PARENT_STORE)) {
                        const parentStore = database.createObjectStore(PARENT_STORE, { keyPath: 'id' });
                        parentStore.createIndex('dateModified', 'dateModified', { unique: false });
                    }
                    if (!database.objectStoreNames.contains(CHILD_STORE)) {
                        const childStore = database.createObjectStore(CHILD_STORE, { keyPath: 'id', autoIncrement: true });
                        childStore.createIndex('parentId', 'parentId', { unique: false });
                        childStore.createIndex('dateAdded', 'dateAdded', { unique: false });
                    }
                };
            });
        }
        
        async function addParent() {
            const titleInput = document.getElementById('newJournalTitle');
            const title = titleInput.value.trim();
            if (!title) { showToast('Please enter a journal title'); return; }
            
            const now = Date.now();
            const parent = { id: 'parent_' + now, title: title, dateModified: now, latestEmotion: null };
            
            const transaction = db.transaction([PARENT_STORE], 'readwrite');
            const store = transaction.objectStore(PARENT_STORE);
            await new Promise((resolve, reject) => {
                const request = store.add(parent);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
            
            titleInput.value = '';
            showToast('Journal created successfully');
            await renderJournals();
        }
        
        function scrollToEntryForm(parentId) {
            const content = document.getElementById(`content_${parentId}`);
            const arrow = document.getElementById(`arrow_${parentId}`);
            const entryForm = document.getElementById(`entryForm_${parentId}`);
            
            // Open accordion if closed
            if (content && !content.classList.contains('open')) {
                content.classList.add('open');
                if (arrow) arrow.classList.add('open');
            }
            
            // Scroll to form with smooth animation
            setTimeout(() => {
                if (entryForm) {
                    entryForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Focus on textarea
                    const textarea = document.getElementById(`notes_${parentId}`);
                    if (textarea) textarea.focus();
                }
            }, 300);
        }
        
        // ==================== IMAGE UPLOAD ====================
        // ImgBB API Key - Ganti dengan API key kamu dari https://api.imgbb.com/
        const IMGBB_API_KEY = '1e1eb87b2595ccf0aad808b26ea24694';
        
        async function handleImageUpload(parentId, input) {
            const file = input.files[0];
            if (!file) return;
            
            // Validate API Key
            if (IMGBB_API_KEY === 'YOUR_IMGBB_API_KEY_HERE') {
                showToast('API Key ImgBB belum diatur. Lihat petunjuk di kode.');
                input.value = '';
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('Gambar terlalu besar (max 5MB)');
                return;
            }
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showToast('File harus berupa gambar');
                return;
            }
            
            // Show loading state
            document.getElementById(`uploadBtn_${parentId}`).classList.add('hidden');
            document.getElementById(`uploadLoading_${parentId}`).classList.remove('hidden');
            
            try {
                const formData = new FormData();
                formData.append('image', file);
                formData.append('expiration', '0'); // 0 = never delete
                
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const imageUrl = data.data.url;
                    document.getElementById(`imageUrl_${parentId}`).value = imageUrl;
                    
                    // Show preview
                    const previewDiv = document.getElementById(`imagePreview_${parentId}`);
                    previewDiv.querySelector('img').src = imageUrl;
                    previewDiv.classList.remove('hidden');
                    
                    showToast('Gambar berhasil diupload!');
                } else {
                    throw new Error(data.error?.message || 'Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showToast('Gagal upload gambar. Cek API Key ImgBB.');
            } finally {
                // Reset loading state
                document.getElementById(`uploadBtn_${parentId}`).classList.remove('hidden');
                document.getElementById(`uploadLoading_${parentId}`).classList.add('hidden');
                // Reset input
                input.value = '';
            }
        }
        
        function removeImage(parentId) {
            document.getElementById(`imageUrl_${parentId}`).value = '';
            document.getElementById(`imagePreview_${parentId}`).classList.add('hidden');
            document.getElementById(`imagePreview_${parentId}`).querySelector('img').src = '';
        }
        
        async function addChild(parentId) {
            const notesInput = document.getElementById(`notes_${parentId}`);
            const notes = notesInput.value.trim();
            if (!notes) { showToast('Please write something'); return; }
            
            const selectedEmoticon = document.querySelector(`[data-parent="${parentId}"].selected`);
            
            // Validate emoji selection
            if (!selectedEmoticon) {
                const warningEl = document.getElementById(`emojiWarning_${parentId}`);
                if (warningEl) {
                    warningEl.classList.remove('hidden');
                    warningEl.classList.add('flex');
                    // Shake animation on emoji container
                    const emojiContainer = document.getElementById(`emojiContainer_${parentId}`);
                    if (emojiContainer) {
                        emojiContainer.style.animation = 'shake 0.5s ease-in-out';
                        setTimeout(() => {
                            emojiContainer.style.animation = '';
                        }, 500);
                    }
                }
                showToast('Please select an emoji first');
                return;
            }
            
            // Hide warning if exists
            const warningEl = document.getElementById(`emojiWarning_${parentId}`);
            if (warningEl) {
                warningEl.classList.add('hidden');
                warningEl.classList.remove('flex');
            }
            
            const emoticon = selectedEmoticon.textContent;
            const imageUrl = document.getElementById(`imageUrl_${parentId}`).value;
            
            const now = Date.now();
            const child = { 
                parentId: parentId, 
                dateAdded: now, 
                notes: notes, 
                emoticon: emoticon,
                imageUrl: imageUrl || null
            };
            
            const transaction = db.transaction([CHILD_STORE, PARENT_STORE], 'readwrite');
            const childStore = transaction.objectStore(CHILD_STORE);
            const parentStore = transaction.objectStore(PARENT_STORE);
            
            await new Promise((resolve, reject) => {
                const request = childStore.add(child);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
            
            const parent = await new Promise((resolve, reject) => {
                const request = parentStore.get(parentId);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
            
            if (parent) {
                parent.dateModified = now;
                parent.latestEmotion = emoticon;
                await new Promise((resolve, reject) => {
                    const request = parentStore.put(parent);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
            
            notesInput.value = '';
            document.querySelectorAll(`[data-parent="${parentId}"]`).forEach(btn => btn.classList.remove('selected'));
            
            // Clear image
            document.getElementById(`imageUrl_${parentId}`).value = '';
            document.getElementById(`imagePreview_${parentId}`).classList.add('hidden');
            document.getElementById(`imagePreview_${parentId}`).querySelector('img').src = '';
            
            showToast('Entry added successfully');
            await renderJournals();
            
            // Check for milestone
            await checkAndShowMilestone();
            
            // Scroll to the newest entry with animation
            setTimeout(() => {
                const content = document.getElementById(`content_${parentId}`);
                const arrow = document.getElementById(`arrow_${parentId}`);
                if (content) content.classList.add('open');
                if (arrow) arrow.classList.add('open');
                
                // Scroll to the newest entry (first one since we sort desc)
                const entriesList = document.getElementById(`entriesList_${parentId}`);
                if (entriesList) {
                    const firstEntry = entriesList.firstElementChild;
                    if (firstEntry) {
                        firstEntry.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // Add highlight animation
                        firstEntry.style.animation = 'pulse 1s ease-in-out';
                        setTimeout(() => {
                            firstEntry.style.animation = '';
                        }, 1000);
                    }
                }
            }, 100);
        }
        
        async function getAllParents() {
            const transaction = db.transaction([PARENT_STORE], 'readonly');
            const store = transaction.objectStore(PARENT_STORE);
            const index = store.index('dateModified');
            return new Promise((resolve, reject) => {
                const request = index.openCursor(null, 'prev');
                const parents = [];
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) { parents.push(cursor.value); cursor.continue(); }
                    else { resolve(parents); }
                };
                request.onerror = () => reject(request.error);
            });
        }
        
        async function getChildrenByParent(parentId) {
            const transaction = db.transaction([CHILD_STORE], 'readonly');
            const store = transaction.objectStore(CHILD_STORE);
            const index = store.index('parentId');
            return new Promise((resolve, reject) => {
                const request = index.openCursor(parentId);
                const children = [];
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) { children.push(cursor.value); cursor.continue(); }
                    else { children.sort((a, b) => b.dateAdded - a.dateAdded); resolve(children); }
                };
                request.onerror = () => reject(request.error);
            });
        }
        
        async function exportData() {
            const parents = await getAllParents();
            const transaction = db.transaction([CHILD_STORE], 'readonly');
            const store = transaction.objectStore(CHILD_STORE);
            const children = await new Promise((resolve, reject) => {
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
            
            const data = { exportDate: new Date().toISOString(), parents: parents, children: children };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `journal_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Backup downloaded successfully');
        }
        
        async function importData(input) {
            const file = input.files[0];
            if (!file) return;
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                if (!data.parents || !data.children) throw new Error('Invalid backup file format');
                
                const transaction = db.transaction([PARENT_STORE, CHILD_STORE], 'readwrite');
                const parentStore = transaction.objectStore(PARENT_STORE);
                const childStore = transaction.objectStore(CHILD_STORE);
                
                await new Promise((resolve, reject) => { const r = parentStore.clear(); r.onsuccess = () => resolve(); r.onerror = () => reject(r.error); });
                await new Promise((resolve, reject) => { const r = childStore.clear(); r.onsuccess = () => resolve(); r.onerror = () => reject(r.error); });
                
                for (const parent of data.parents) await new Promise((resolve, reject) => { const r = parentStore.add(parent); r.onsuccess = () => resolve(); r.onerror = () => reject(r.error); });
                for (const child of data.children) await new Promise((resolve, reject) => { const r = childStore.add(child); r.onsuccess = () => resolve(); r.onerror = () => reject(r.error); });
                
                showToast('Data imported successfully');
                await renderJournals();
            } catch (error) { showToast('Error importing file: ' + error.message); }
            input.value = '';
        }
        
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getFullYear()).slice(-2)}`;
        }
        
        function formatDateTime(timestamp) {
            return new Date(timestamp).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }
        
        async function renderJournals() {
            const parents = await getAllParents();
            const container = document.getElementById('journalsList');
            const emptyState = document.getElementById('emptyState');
            
            if (parents.length === 0) { container.innerHTML = ''; emptyState.classList.remove('hidden'); return; }
            emptyState.classList.add('hidden');
            
            let html = '';
            for (const parent of parents) {
                const children = await getChildrenByParent(parent.id);
                html += await renderParentCard(parent, children);
            }
            container.innerHTML = html;
        }
        
        async function renderParentCard(parent, children) {
            const entryCount = children.length;
            const latestEmotion = parent.latestEmotion || 'âœï¸';
            
            let childrenHtml = '';
            if (children.length > 0) {
                childrenHtml = children.map(child => {
                    const imageHtml = child.imageUrl ? `
                        <div class="mt-3 mb-2">
                            <a href="${child.imageUrl}" target="_blank" rel="noopener noreferrer" class="block">
                                <img src="${child.imageUrl}" alt="Entry image" class="w-full max-h-64 object-cover rounded-xl border border-slate-200 hover:opacity-90 transition-opacity cursor-zoom-in">
                            </a>
                        </div>
                    ` : '';
                    return `
                    <div class="entry-card bg-white/70 backdrop-blur-sm rounded-2xl p-5 mb-3 border border-white/40 shadow-sm">
                        <div class="flex gap-4">
                            <div class="mood-indicator text-3xl">${child.emoticon}</div>
                            <div class="flex-1 min-w-0">
                                <p class="text-slate-700 text-sm leading-relaxed whitespace-pre-wrap">${linkifyText(child.notes)}</p>
                                ${imageHtml}
                                <p class="entry-time text-xs text-slate-400 mt-3 font-medium">${formatDateTime(child.dateAdded)}</p>
                            </div>
                        </div>
                    </div>
                `}).join('');
            } else {
                childrenHtml = `
                    <div class="text-center py-10">
                        <div class="w-16 h-16 mx-auto mb-3 rounded-full bg-slate-100 flex items-center justify-center">
                            <span class="text-2xl">ðŸ“</span>
                        </div>
                        <p class="text-slate-400 text-sm">No entries yet</p>
                        <p class="text-slate-300 text-xs mt-1">Add your first thought below</p>
                    </div>
                `;
            }
            
            const emoticonButtons = EMOTICONS.map(emoji => `
                <button onclick="selectEmoticon('${parent.id}', '${emoji}', this)" data-parent="${parent.id}"
                    class="emoji-btn w-11 h-11 text-xl rounded-xl bg-white/50 hover:bg-white flex items-center justify-center shadow-sm">${emoji}</button>
            `).join('');
            
            return `
                <div class="journal-card glass rounded-3xl overflow-hidden shadow-xl shadow-black/5" id="journal_${parent.id}">
                    <div onclick="toggleAccordion('${parent.id}')" class="p-5 cursor-pointer hover:bg-white/40 transition-all group">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4 min-w-0">
                                <div class="mood-indicator w-12 h-12 rounded-2xl bg-slate-100 flex items-center justify-center text-2xl flex-shrink-0">${latestEmotion}</div>
                                <div class="min-w-0">
                                    <h3 class="font-semibold text-slate-800 text-base truncate">${escapeHtml(parent.title)}</h3>
                                    <div class="flex items-center gap-2 mt-0.5">
                                        <span class="text-xs text-slate-500">${formatDate(parent.dateModified)}</span>
                                        <span class="badge px-2 py-0.5 rounded-full text-xs font-medium text-slate-600">${entryCount} ${entryCount === 1 ? 'entry' : 'entries'}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="event.stopPropagation(); scrollToEntryForm('${parent.id}')" 
                                    class="new-entry-btn flex items-center justify-center w-8 h-8 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg transition-all shadow-sm hover:shadow-md"
                                    title="Add new entry">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" strokeLinejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                </button>
                                <svg id="arrow_${parent.id}" class="rotate-arrow w-5 h-5 text-slate-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" strokeLinejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div id="content_${parent.id}" class="accordion-content border-t border-white/30">
                        <div class="p-5">
                            <div id="entriesList_${parent.id}" class="mb-5">${childrenHtml}</div>
                            <div id="entryForm_${parent.id}" class="bg-slate-50/80 rounded-2xl p-5 border border-slate-100">
                                <p class="text-xs font-semibold text-slate-600 uppercase tracking-wider mb-3">New Entry</p>
                                <div class="flex flex-wrap gap-2 mb-2" id="emojiContainer_${parent.id}">${emoticonButtons}</div>
                                <div class="flex items-center gap-2 mb-2">
                                    <input type="text" id="customEmoji_${parent.id}" placeholder="âŒ¨ï¸ Other emoji..." maxlength="2" 
                                        class="w-28 px-3 py-1.5 text-sm bg-white/50 border border-slate-200 rounded-lg focus:outline-none focus:border-emerald-400 transition-colors"
                                        onkeydown="if(event.key==='Enter'){event.preventDefault();addCustomEmoji('${parent.id}')}">
                                    <button onclick="addCustomEmoji('${parent.id}')" 
                                        class="px-3 py-1.5 text-xs bg-slate-100 hover:bg-emerald-100 text-slate-600 hover:text-emerald-700 rounded-lg transition-colors">
                                        + Add
                                    </button>
                                </div>
                                <p id="emojiWarning_${parent.id}" class="hidden text-xs text-red-500 mb-2 flex items-center gap-1">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" strokeLinejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span>Please select an emoji first</span>
                                </p>
                                
                                <!-- Image Upload Section -->
                                <div class="mb-3">
                                    <input type="file" id="imageInput_${parent.id}" accept="image/*" class="hidden" onchange="handleImageUpload('${parent.id}', this)">
                                    <input type="hidden" id="imageUrl_${parent.id}" value="">
                                    
                                    <!-- Upload Button -->
                                    <button onclick="document.getElementById('imageInput_${parent.id}').click()" 
                                        id="uploadBtn_${parent.id}"
                                        class="w-full py-2.5 px-4 bg-white border border-slate-200 border-dashed rounded-xl text-slate-600 hover:border-emerald-400 hover:text-emerald-600 transition-all flex items-center justify-center gap-2 text-sm">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" strokeLinejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                        <span>Add Image</span>
                                    </button>
                                    
                                    <!-- Loading State -->
                                    <div id="uploadLoading_${parent.id}" class="hidden py-2.5 px-4 bg-slate-100 rounded-xl flex items-center justify-center gap-2 text-sm text-slate-500">
                                        <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span>Mengupload...</span>
                                    </div>
                                    
                                    <!-- Preview -->
                                    <div id="imagePreview_${parent.id}" class="hidden mt-2 relative">
                                        <img src="" alt="Preview" class="w-full h-32 object-cover rounded-xl border border-slate-200">
                                        <button onclick="removeImage('${parent.id}')" class="absolute top-2 right-2 w-6 h-6 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center text-xs shadow-md">
                                            âœ•
                                        </button>
                                    </div>
                                </div>
                                
                                <textarea id="notes_${parent.id}" placeholder="What's on your mind?" 
                                    class="w-full px-4 py-3 bg-white/90 border border-slate-200 rounded-xl focus:outline-none focus:border-slate-400 focus:bg-white resize-none h-24 text-sm text-slate-700 placeholder-slate-400 transition-all mb-3"></textarea>
                                <button onclick="addChild('${parent.id}')" 
                                    class="w-full py-3 bg-slate-800 hover:bg-slate-900 text-white font-medium rounded-xl transition-all flex items-center justify-center gap-2 shadow-lg shadow-slate-800/20 hover:shadow-slate-800/30">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" strokeLinejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    <span>Add Entry</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function toggleAccordion(parentId) {
            const content = document.getElementById(`content_${parentId}`);
            const arrow = document.getElementById(`arrow_${parentId}`);
            if (content.classList.contains('open')) {
                content.classList.remove('open');
                arrow.classList.remove('open');
            } else {
                content.classList.add('open');
                arrow.classList.add('open');
            }
        }
        
        function selectEmoticon(parentId, emoji, btn) {
            document.querySelectorAll(`[data-parent="${parentId}"]`).forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        }
        
        function addCustomEmoji(parentId) {
            const input = document.getElementById(`customEmoji_${parentId}`);
            const emoji = input.value.trim();
            
            if (!emoji) {
                showToast('Please enter an emoji first');
                return;
            }
            
            // Remove previous selection
            document.querySelectorAll(`[data-parent="${parentId}"]`).forEach(b => b.classList.remove('selected'));
            
            // Create new emoji button
            const container = document.getElementById(`emojiContainer_${parentId}`);
            const btn = document.createElement('button');
            btn.innerHTML = emoji;
            btn.setAttribute('data-parent', parentId);
            btn.className = 'emoji-btn w-11 h-11 text-xl rounded-xl bg-white/50 hover:bg-white flex items-center justify-center shadow-sm selected';
            btn.onclick = function() { selectEmoticon(parentId, emoji, this); };
            
            // Insert before the input area
            container.appendChild(btn);
            
            // Clear input
            input.value = '';
            
            // Scroll to show the new button
            container.scrollLeft = container.scrollWidth;
            
            showToast('Emoji ditambahkan!');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function linkifyText(text) {
            // URL regex pattern
            const urlPattern = /(https?:\/\/[^\s]+)/g;
            
            // Escape HTML first
            let escaped = escapeHtml(text);
            
            // Replace URLs with buttons
            escaped = escaped.replace(urlPattern, (url) => {
                // Create a short display text
                let displayText = 'Link';
                try {
                    const urlObj = new URL(url);
                    // If URL is short enough, show domain only
                    if (url.length < 40) {
                        displayText = urlObj.hostname;
                    }
                } catch (e) {
                    // Invalid URL, just show "Link"
                }
                
                return `<a href="${url}" target="_blank" rel="noopener noreferrer" 
                    class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-slate-100 hover:bg-slate-200 text-slate-700 text-xs font-medium rounded-lg transition-colors border border-slate-200">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" strokeLinejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                    </svg>
                    <span>${displayText}</span>
                </a>`;
            });
            
            return escaped;
        }
        
        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.remove('translate-x-full', 'opacity-0');
            setTimeout(() => { toast.classList.add('translate-x-full', 'opacity-0'); }, 3000);
        }
        
        // ==================== MILESTONE NOTIFICATIONS ====================
        // Pattern: edu (+5), edu (+5), donation (+15), repeat... until 175
        const MILESTONES = [5, 10, 25, 30, 35, 50, 55, 60, 75, 80, 85, 100, 105, 110, 125, 130, 135, 150, 155, 160, 175];
        
        // Education content - 12 items for rotation (2 per cycle, 6 cycles until 175)
        const EDUCATION_CONTENTS = [
            {
                icon: 'ðŸ’¡',
                title: 'The Power of Consistent Journaling',
                color: 'from-amber-400 to-orange-500',
                paragraphs: [
                    'Journaling is not just about recordingâ€”it is a <strong>mental investment</strong> that pays dividends throughout life. Every entry you write helps the brain process emotions, reduce stress, and increase self-awareness.',
                    'Studies show people who journal regularly have <strong>42% less stress</strong> and are <strong>25% happier</strong>. You are building a habit that will change your life. Keep going! âœ¨'
                ]
            },
            {
                icon: 'ðŸ§ ',
                title: 'Why is X Journal 100% Local?',
                color: 'from-emerald-400 to-teal-500',
                paragraphs: [
                    'X Journal uses IndexedDBâ€”all data is stored <strong>on your own device</strong>, not in the cloud. This means your privacy is 100% protected. No one can read your journal, not even the creator of this application.',
                    'However, this also means you are responsible for your own data. Regularly export backups via the Database menu. Remember: <strong>data ownership = power</strong>. You have full control over your life story. ðŸ”’'
                ]
            },
            {
                icon: 'ðŸŽ¯',
                title: 'Morning Pages: A Morning Routine That Changes Lives',
                color: 'from-blue-400 to-indigo-500',
                paragraphs: [
                    '<strong>Morning Pages</strong> is a technique of writing 3 full pages every morning without filters. No need to think, no need to editâ€”write whatever is on your mind. This clears "mental clutter" before starting the day.',
                    'Many writers, CEOs, and successful creators use this technique. You can create a special "Morning Pages" journal in X Journal. Try to be consistent for 30 days and feel the difference. ðŸŒ…'
                ]
            },
            {
                icon: 'ðŸ“Š',
                title: 'Mood Tracking: Recognizing Your Emotional Patterns',
                color: 'from-violet-400 to-purple-500',
                paragraphs: [
                    'Every time you choose a mood emoji, X Journal records it. From this data, you can see <strong>emotional patterns</strong> over weeks. Are Mondays always tough? Is the third week of the month always productive?',
                    'The Data Analysis in the Database menu can show your dominant mood. This is a powerful tool for understanding yourself. So, don\'t skip choosing an emojiâ€”it is valuable data! ðŸ“ˆ'
                ]
            },
            {
                icon: 'ðŸ”—',
                title: 'Linkify Feature: Your Interactive Journal',
                color: 'from-cyan-400 to-blue-500',
                paragraphs: [
                    'Did you know? X Journal automatically detects URLs in your notes and turns them into <strong>clickable buttons</strong>. This is very useful for saving article references, videos, or playlists related to your entries.',
                    'Pro tip: Save the link to the song you are listening to while writing. Later, when you re-read old entries, you can click and feel the vibes again. Music + memory = time travel! ðŸŽµ'
                ]
            },
            {
                icon: 'ðŸŽ¨',
                title: 'Background Customization: Mood = Space',
                color: 'from-pink-400 to-rose-500',
                paragraphs: [
                    'Visual environment affects creativity. That is why X Journal provides <strong>27+ background choices</strong>â€”from animated gradients to nature and city photos. Change the background according to your mood or journal topic.',
                    'Venting? Try a dark background. Planning dreams? Choose sunset or aurora. Focusing on work? Forest or ocean fits. Your digital space, arrange it as you like! ðŸŒˆ'
                ]
            },
            {
                icon: 'âš¡',
                title: 'Streak Power: Don\'t Break the Chain!',
                color: 'from-orange-400 to-red-500',
                paragraphs: [
                    'Data Analysis displays your <strong>journaling streak</strong>â€”how many consecutive days you have written. Streak is a powerful psychological motivator. The longer the streak, the stronger the desire to maintain it.',
                    'But remember: one missed day does not mean failure. Don\'t get caught in "all or nothing thinking". If the streak breaks, start again from 1. What matters is <strong>consistency over perfection</strong>. ðŸ”¥'
                ]
            },
            {
                icon: 'ðŸ”',
                title: 'Export Data: Backup is Power',
                color: 'from-slate-400 to-gray-500',
                paragraphs: [
                    'X Journal stores data locally, but devices can break, get lost, or be reset. That is why the <strong>Export</strong> feature is very important. One click, all your journals are saved in a JSON file that can be imported anytime.',
                    'Tip: export every week or month. Save the file in cloud storage (Google Drive, Dropbox) or send it to email. This is your life archiveâ€”take good care of it! ðŸ“¦'
                ]
            },
            {
                icon: 'ðŸ“±',
                title: 'Install as PWA: Instant Access',
                color: 'from-indigo-400 to-violet-500',
                paragraphs: [
                    'X Journal is a <strong>Progressive Web App (PWA)</strong>. You can "install" it on your homescreen, it looks like a native app, and works offline. No need to download from the App Store!',
                    'How to: on Chrome/Android, tap menu â‹® â†’ "Install". On iOS, tap Share â†’ "Add to Home Screen". After install, X Journal can be opened without browser chrome, faster, and more immersive. Try it! ðŸš€'
                ]
            },
            {
                icon: 'ðŸŒ™',
                title: 'Evening Reflection: Close the Day with Gratitude',
                color: 'from-indigo-500 to-blue-600',
                paragraphs: [
                    'Before sleeping, take 5 minutes to write <strong>3 things you are grateful for today</strong>. Can be as small as a cup of good coffee, can be as big as a job promotion. This simple exercise scientifically increases happiness.',
                    'Create a special "Gratitude" or "Evening Reflection" journal. Sleeping with positive thoughts improves rest quality and prepares you for a better day tomorrow. ðŸŒŸ'
                ]
            },
            {
                icon: 'ðŸŽ­',
                title: 'Persona Template: Start with Examples',
                color: 'from-fuchsia-400 to-pink-500',
                paragraphs: [
                    'Confused about what to write? X Journal provides <strong>10+ persona templates</strong>â€”from Students, Professionals, to Mindmap Declutter. Each template has a ready-to-use journal structure.',
                    'You can import templates when first using, or reset data and choose other templates for exploration. Doesn\'t have to match 100%â€”modify according to your needs. Templates are stepping stones, not rigid rules! ðŸŽ¨'
                ]
            },
            {
                icon: 'ðŸ’ª',
                title: 'Small Habits, Big Impact',
                color: 'from-lime-400 to-green-500',
                paragraphs: [
                    'James Clear\'s Atomic Habits teaches: <strong>1% better every day</strong> will make you 37x better in a year. Journaling is a small habit with extraordinary compound effects.',
                    'Every entry is a small brick in the foundation of self-understanding. From 5 entries, to 25, to 175, to thousands. One day, you will re-read and be amazed at how far you have grown. ðŸŒ±'
                ]
            }
        ];
        
        // Donation content (same for all donation milestones)
        const DONATION_CONTENT = {
            icon: 'ðŸ’š',
            title: 'Support X Journal',
            color: 'from-emerald-500 to-green-500',
            paragraphs: [
                'X Journal is built with love and is <strong>100% free</strong> without ads. But servers, domains, and development time cost money. Every donation, no matter how small, means a lot to keep this application running.',
                'If X Journal helps make your day better, consider <strong>buying me a coffee</strong>. Your support allows me to continue adding features and maintaining quality. Thank you for being part of this journey! ðŸ™'
            ],
            cta: {
                text: 'Support X Journal ðŸ’š',
                url: 'https://paypal.me/ariefdrip'
            }
        };
        
        let currentMilestone = null;
        
        function getMilestoneContent(entryCount) {
            const milestoneIndex = MILESTONES.indexOf(entryCount);
            const cyclePosition = milestoneIndex % 3; // 0, 1 = education, 2 = donation
            
            if (cyclePosition === 2) {
                // Every 3rd milestone (index 2, 5, 8, 11, 14, 17, 20) is donation
                return { type: 'donation', content: DONATION_CONTENT };
            } else {
                // Map education milestones to content array
                // Milestone 0,1 -> edu 0,1 | 3,4 -> edu 2,3 | 6,7 -> edu 4,5 | etc.
                const eduIndex = Math.floor(milestoneIndex / 3) * 2 + cyclePosition;
                // Use modulo to cycle through education contents if we run out
                const safeEduIndex = eduIndex % EDUCATION_CONTENTS.length;
                return { type: 'education', content: EDUCATION_CONTENTS[safeEduIndex] };
            }
        }
        
        async function checkAndShowMilestone() {
            // Get total entries count
            const transaction = db.transaction([CHILD_STORE], 'readonly');
            const store = transaction.objectStore(CHILD_STORE);
            const count = await new Promise((resolve, reject) => {
                const request = store.count();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
            
            // Check if this is a milestone and hasn't been shown
            if (MILESTONES.includes(count)) {
                const shownKey = `milestone_shown_${count}`;
                if (!localStorage.getItem(shownKey)) {
                    showMilestoneNotification(count);
                    localStorage.setItem(shownKey, 'true');
                }
            }
        }
        
        function showMilestoneNotification(entryCount) {
            currentMilestone = entryCount;
            const content = getMilestoneContent(entryCount);
            const isDonation = content.type === 'donation';
            
            // Small toast notification (5-6 words)
            const toastMessages = [
                `${entryCount} entries! Great job ðŸŽ‰`,
                `Wow, ${entryCount} stories! âœ¨`,
                `${entryCount} entries! Check this ðŸ‘†`,
                `Milestone ${entryCount}! Tap me ðŸ’¡`,
                `${entryCount}x writing! Got reward ðŸŽ`
            ];
            const randomMessage = toastMessages[Math.floor(Math.random() * toastMessages.length)];
            
            document.getElementById('milestoneIcon').textContent = content.content.icon;
            document.getElementById('milestoneText').textContent = randomMessage;
            
            const toast = document.getElementById('milestoneToast');
            toast.classList.remove('hidden');
            
            // Auto-hide after 10 seconds if not clicked
            setTimeout(() => {
                if (!toast.classList.contains('hidden') && !document.getElementById('milestoneModal').classList.contains('flex')) {
                    hideMilestoneNotification();
                }
            }, 10000);
        }
        
        function hideMilestoneNotification() {
            const toast = document.getElementById('milestoneToast');
            toast.classList.add('hiding');
            setTimeout(() => {
                toast.classList.add('hidden');
                toast.classList.remove('hiding');
            }, 300);
        }
        
        function handleMilestoneClick() {
            hideMilestoneNotification();
            if (currentMilestone) {
                showMilestoneModal(currentMilestone);
            }
        }
        
        function showMilestoneModal(entryCount) {
            const content = getMilestoneContent(entryCount);
            const data = content.content;
            
            // Update icon
            document.getElementById('milestoneModalIcon').textContent = data.icon;
            document.getElementById('milestoneModalIcon').className = `w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br ${data.color} flex items-center justify-center text-3xl shadow-lg`;
            
            // Update title and number
            document.getElementById('milestoneModalTitle').textContent = data.title;
            document.getElementById('milestoneNumber').textContent = entryCount;
            
            // Build content
            let contentHtml = '';
            data.paragraphs.forEach(para => {
                contentHtml += `<p class="text-sm text-slate-600 leading-relaxed">${para}</p>`;
            });
            
            // Add CTA for donation
            if (content.type === 'donation' && DONATION_CONTENT.cta) {
                contentHtml += `
                    <a href="${DONATION_CONTENT.cta.url}" target="_blank" rel="noopener noreferrer"
                       class="block mt-4 p-4 bg-gradient-to-r from-emerald-50 to-green-50 border border-emerald-200 rounded-2xl hover:border-emerald-300 transition-all group">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-500 to-green-500 flex items-center justify-center text-lg shadow-md group-hover:scale-110 transition-transform">
                                ðŸ’š
                            </div>
                            <div class="flex-1">
                                <p class="font-semibold text-slate-800 text-sm">${DONATION_CONTENT.cta.text}</p>
                                <p class="text-xs text-slate-500">via PayPal (secure)</p>
                            </div>
                            <svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                            </svg>
                        </div>
                    </a>
                `;
            }
            
            document.getElementById('milestoneModalContent').innerHTML = contentHtml;
            
            // Show modal
            const modal = document.getElementById('milestoneModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        function closeMilestoneModal() {
            const modal = document.getElementById('milestoneModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            currentMilestone = null;
        }
        
        // Dropdown menu functions
        function toggleDropdown(menuId) {
            const menu = document.getElementById(menuId);
            const isOpen = !menu.classList.contains('hidden');
            
            // Close all dropdowns first
            closeAllDropdowns();
            
            // Toggle current
            if (!isOpen) {
                menu.classList.remove('hidden');
            }
        }
        
        function closeDropdown(menuId) {
            document.getElementById(menuId).classList.add('hidden');
        }
        
        function closeAllDropdowns() {
            document.getElementById('dataMenu').classList.add('hidden');
            document.getElementById('loveMenu').classList.add('hidden');
        }
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            const dataContainer = document.getElementById('dataMenuContainer');
            const loveContainer = document.getElementById('loveMenuContainer');
            
            if (!dataContainer.contains(e.target) && !loveContainer.contains(e.target)) {
                closeAllDropdowns();
            }
        });
        
        // Create and inject manifest dynamically
        const manifest = {
            name: "X Journal",
            short_name: "XJournal",
            start_url: ".",
            display: "standalone",
            background_color: "#ffffff",
            theme_color: "#6366f1",
            orientation: "portrait-primary",
            scope: ".",
            icons: [
                {
                    src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect fill='%234f46e5' rx='40' width='192' height='192'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='100'%3EðŸ““%3C/text%3E%3C/svg%3E",
                    sizes: "192x192",
                    type: "image/svg+xml",
                    purpose: "any maskable"
                },
                {
                    src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect fill='%234f46e5' rx='100' width='512' height='512'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='280'%3EðŸ““%3C/text%3E%3C/svg%3E",
                    sizes: "512x512",
                    type: "image/svg+xml",
                    purpose: "any maskable"
                }
            ]
        };
        
        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('manifestLink').href = manifestURL;
        
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'x-journal-v1';
                const urlsToCache = ['./'];
                
                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then(cache => cache.addAll(urlsToCache))
                            .then(() => self.skipWaiting())
                    );
                });
                
                self.addEventListener('activate', event => {
                    event.waitUntil(self.clients.claim());
                });
                
                self.addEventListener('fetch', event => {
                    event.respondWith(
                        caches.match(event.request).then(response => {
                            if (response) return response;
                            return fetch(event.request).catch(() => {
                                return new Response('Offline - X Journal');
                            });
                        })
                    );
                });
            `;
            
            const swBlob = new Blob([swCode], { type: 'text/javascript' });
            const swURL = URL.createObjectURL(swBlob);
            
            navigator.serviceWorker.register(swURL)
                .then(reg => console.log('SW registered:', reg))
                .catch(err => console.log('SW registration failed:', err));
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initDB();
                initBackgroundSelector();
                initPWAInstall();
                
                // Restore saved background
                const savedBgType = localStorage.getItem('journalBgType');
                const savedBgVariant = localStorage.getItem('journalBgVariant');
                if (savedBgType === 'image' && savedBgVariant) {
                    setBackground('image', savedBgVariant);
                } else if (savedBgType === 'gradient' && savedBgVariant) {
                    setBackground('gradient', savedBgVariant, `g-${savedBgVariant}`);
                }
                
                await renderJournals();
            } catch (error) {
                console.error('Error initializing app:', error);
                showToast('Error initializing app');
            }
        });
        
        document.getElementById('newJournalTitle')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addParent();
        });
    </script>
</body>
</html>
